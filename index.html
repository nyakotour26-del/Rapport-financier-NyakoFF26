<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAPPORT FINANCIER TOURN√âE 2026</title>
    <style>
        :root {
            --primary-color: #2980b9;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --text-color: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 40px 20px;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 50%, #c8e6c9 100%);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            border: 2px solid #4CAF50;
        }
        
        h1 {
            color: #2e7d32;
            margin-bottom: 15px;
            font-size: 2.5em;
        }
        
        header p {
            color: #388e3c;
            font-size: 1.2em;
            font-weight: 500;
        }
        
        .stats-section {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }
        
        .stats-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .search-section {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }
        
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        
        .calendar-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .calendar {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 15px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 8px;
            background-color: var(--light-color);
            border-radius: 4px;
        }
        
        .calendar-day {
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            position: relative;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .calendar-day:hover {
            background-color: var(--light-color);
        }
        
        .calendar-day.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .calendar-day.has-data {
            font-weight: bold;
        }
        
        .calendar-day.other-month {
            color: #ccc;
        }
        
        .date-info {
            font-size: 0.7em;
            line-height: 1.2;
        }
        
        .localite {
            color: #2980b9;
            font-weight: bold;
        }
        
        .pays {
            color: #e74c3c;
            font-weight: bold;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        input, select, button {
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            width: 100%;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            min-width: 150px;
        }
        
        button:hover {
            background-color: #1f6391;
        }
        
        button.secondary {
            background-color: #7f8c8d;
        }
        
        button.secondary:hover {
            background-color: #6c7a7d;
        }
        
        .financial-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .financial-table th {
            background: var(--light-color);
            color: var(--primary-color);
            font-weight: bold;
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .financial-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: right;
        }
        
        .financial-table .category {
            background: #f8f9fa;
            font-weight: bold;
            text-align: left;
        }
        
        .financial-table .recettes-row {
            background: #d4edda;
            font-weight: bold;
        }
        
        .financial-table .depenses-row {
            background: #f8d7da;
            font-weight: bold;
        }
        
        .financial-table .difference-row {
            background: #d1ecf1;
            font-weight: bold;
        }
        
        .results-section {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-top: 30px;
        }
        
        .result-header {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-content {
            padding: 20px;
        }
        
        .pv-item {
            margin-bottom: 40px;
            border: 1px solid #e1e1e1;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .pv-header {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 50%, #c8e6c9 100%);
            color: #2e7d32;
            padding: 25px;
            border-bottom: 3px solid #4CAF50;
        }
        
        .pv-title {
            color: #2e7d32;
            font-weight: bold;
            margin-top: 0;
            font-size: 1.6em;
        }
        
        .location-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-left: 4px solid #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        .error-message {
            background-color: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        
        .retry-options {
            background: #fff3cd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            border-left: 4px solid #ffc107;
            display: none;
        }
        
        .retry-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .retry-buttons button {
            flex: 1;
            min-width: 120px;
        }
        
        .country-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .country-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
            max-width: 200px;
        }
        
        .country-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .country-button.suisse {
            background-color: #e74c3c;
        }
        
        .country-button.france {
            background-color: #2980b9;
        }
        
        .country-button.allemagne {
            background-color: #2c3e50;
        }
        
        .country-button.belgique {
            background-color: #f39c12;
        }
        
        .country-button.wales {
            background-color: #27ae60;
        }
        
        .country-button.angleterre {
            background-color: #9b59b6;
        }
        
        .external-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0 20px 0;
            justify-content: center;
        }
        
        .external-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .external-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .external-button.rubriques {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .external-button.recap {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        /* NOUVEAU: Conteneur pour le d√©filement horizontal */
        .table-scroll-container {
            width: 100%;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e1e1e1;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .country-summary-table {
            width: auto;
            min-width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin: 0;
        }
        
        .country-summary-table th {
            background: #2c3e50;
            color: white;
            font-weight: bold;
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            white-space: nowrap;
        }
        
        .country-summary-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: right;
            white-space: nowrap;
        }
        
        .country-summary-table .date-cell {
            text-align: left;
            font-weight: bold;
            position: sticky;
            left: 0;
            background: #f8f9fa;
            z-index: 1;
        }
        
        .country-summary-table .total-row {
            background: #d1ecf1;
            font-weight: bold;
        }
        
        .country-summary-table .currency-column {
            background: #f8f9fa;
        }
        
        .country-summary-table .currency-header {
            background: #3498db;
            color: white;
            font-size: 1.1em;
        }
        
        .country-summary-table .sub-header {
            background: #2980b9;
            color: white;
        }
        
        /* Indicateur de d√©filement pour mobile */
        .scroll-hint {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
            margin: 10px 0;
            display: none;
        }
        
        .scroll-hint::after {
            content: "‚Üê ‚Üí";
            display: block;
            font-weight: bold;
            font-size: 16px;
            margin-top: 5px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .financial-table {
                font-size: 12px;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 5px;
            }
            
            .retry-buttons {
                flex-direction: column;
            }
            
            .country-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .country-button {
                max-width: 100%;
            }
            
            .external-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .external-button {
                max-width: 100%;
            }
            
            .country-summary-table {
                font-size: 12px;
            }
            
            .country-summary-table th,
            .country-summary-table td {
                padding: 8px 6px;
            }
            
            /* Afficher l'indicateur de d√©filement sur mobile */
            .scroll-hint {
                display: block;
            }
        }
        
        @media (max-width: 480px) {
            .country-summary-table {
                font-size: 11px;
            }
            
            .country-summary-table th,
            .country-summary-table td {
                padding: 6px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí∞ RAPPORT FINANCIER TOURN√âE 2026</h1>
            <p>Navigation par date et recherche dans les donn√©es financi√®res</p>
        </header>
        
        <section class="stats-section" id="statsSection">
            <!-- TITRE MODIFI√â ICI -->
            <h2>üìä RECAPITULATIF GLOBAL</h2>
            
            <div id="globalStats">
                <!-- Les statistiques globales seront affich√©es ici -->
            </div>
            
            <!-- Nouvelle section pour les boutons externes - Positionn√©e sous le tableau -->
            <div class="external-buttons">
                <button class="external-button rubriques" onclick="window.open('https://nyakotour26-del.github.io/recap_DETAILS/', '_blank')">
                    üìã Rubriques D√©tails
                </button>
                <button class="external-button recap" onclick="window.open('https://nyakotour26-del.github.io/RECAP-GL/', '_blank')">
                    üìà Recap GL
                </button>
            </div>
            
            <h2 style="margin-top: 30px;">üåç R√âCAPITULATIF PAR PAYS</h2>
            <div class="country-buttons" id="countryButtons">
                <button class="country-button suisse" data-pays="SUISSE">üá®üá≠ SUISSE</button>
                <button class="country-button france" data-pays="FRANCE">üá´üá∑ FRANCE</button>
                <button class="country-button allemagne" data-pays="ALLEMAGNE">üá©üá™ ALLEMAGNE</button>
                <button class="country-button belgique" data-pays="BELGIQUE">üáßüá™ BELGIQUE</button>
                <button class="country-button wales" data-pays="WALES">üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø WALES</button>
                <button class="country-button angleterre" data-pays="ANGLETERRE">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø ANGLETERRE</button>
            </div>
        </section>
        
        <section class="search-section">
            <form id="searchForm" class="search-form" autocomplete="off">
                <div class="form-group">
                    <label for="searchText">Rechercher un mot ou une phrase :</label>
                    <input type="text" id="searchText" placeholder="Entrez votre recherche..." autocomplete="off">
                </div>
                
                <div class="form-group">
                    <button type="submit">üîç Rechercher</button>
                </div>
            </form>
            
            <div class="retry-options" id="retryOptions">
                <h3>Probl√®me de chargement ?</h3>
                <p>Essayez une autre m√©thode de connexion :</p>
                <div class="retry-buttons">
                    <button id="tryDirect" style="background-color: #3498db;">M√©thode Standard</button>
                    <button id="tryProxy" style="background-color: #9b59b6;">M√©thode Alternative 1</button>
                    <button id="tryCors" style="background-color: #e67e22;">M√©thode Alternative 2</button>
                </div>
            </div>
            
            <div class="calendar-container">
                <div class="calendar">
                    <div class="calendar-header">
                        <button id="prevMonth" class="secondary">‚óÄ</button>
                        <h3 id="currentMonth"></h3>
                        <button id="nextMonth" class="secondary">‚ñ∂</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Le calendrier sera g√©n√©r√© ici -->
                    </div>
                </div>
            </div>
            
            <button id="showAllButton" style="background-color: #27ae60; margin-top: 15px;">
                üìä Afficher toutes les donn√©es financi√®res
            </button>
        </section>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Chargement des donn√©es depuis Google Sheets...</p>
        </div>

        <section class="results-section" id="resultsSection">
            <div class="result-header">
                <h2 id="resultTitle">R√©sultats de la recherche</h2>
                <button id="closeResults">‚úï Fermer</button>
            </div>
            <div class="result-content" id="resultContent">
                <!-- Les r√©sultats seront affich√©es ici -->
            </div>
        </section>
    </div>

    <script>
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSrF0hs00W-QvR3v5wxZA1ceGEx4xWR0dJv5kF3zgab6YVV00OehcwxYg-EJfOrMqj4IJnDl649SIkg/pub?gid=106676164&single=true&output=csv';
        
        let sheetData = [];
        let headers = [];
        let datesWithData = [];
        let currentDate = new Date(2026, 3, 1);
        let selectedDate = null;
        let currentSearchTerm = '';
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchForm').addEventListener('submit', handleSearch);
            document.getElementById('prevMonth').addEventListener('click', prevMonth);
            document.getElementById('nextMonth').addEventListener('click', nextMonth);
            document.getElementById('showAllButton').addEventListener('click', showAllData);
            document.getElementById('closeResults').addEventListener('click', closeResults);
            document.getElementById('tryDirect').addEventListener('click', () => loadDataFromGoogleSheets('direct'));
            document.getElementById('tryProxy').addEventListener('click', () => loadDataFromGoogleSheets('proxy'));
            document.getElementById('tryCors').addEventListener('click', () => loadDataFromGoogleSheets('cors'));
            
            // Ajouter les √©v√©nements pour les boutons de pays
            const countryButtons = document.querySelectorAll('.country-button');
            countryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const pays = this.getAttribute('data-pays');
                    showCountrySummary(pays);
                });
            });
            
            // Chargement automatique avec la m√©thode directe
            loadDataFromGoogleSheets('direct');
        });

        async function loadDataFromGoogleSheets(method = 'direct') {
            console.log(`üîç Tentative de chargement avec m√©thode: ${method}`);
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('retryOptions').style.display = 'none';
            clearErrorMessages();
            
            try {
                let response;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                switch(method) {
                    case 'direct':
                        response = await fetch(GOOGLE_SHEETS_URL, {
                            signal: controller.signal,
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        break;
                        
                    case 'proxy':
                        const proxyUrl = `https://cors-anywhere.herokuapp.com/${GOOGLE_SHEETS_URL}`;
                        response = await fetch(proxyUrl, {
                            signal: controller.signal,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        break;
                        
                    case 'cors':
                        const corsProxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(GOOGLE_SHEETS_URL)}`;
                        response = await fetch(corsProxy, {
                            signal: controller.signal
                        });
                        break;
                }
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const csvText = await response.text();
                    console.log('‚úÖ Donn√©es charg√©es avec succ√®s');
                    processCSVData(csvText);
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
            } catch (error) {
                console.log(`‚ùå √âchec avec ${method}:`, error.message);
                
                // Essayer la m√©thode suivante automatiquement
                if (method === 'direct') {
                    console.log('üîÑ Essai automatique avec m√©thode proxy...');
                    loadDataFromGoogleSheets('proxy');
                } else if (method === 'proxy') {
                    console.log('üîÑ Essai automatique avec m√©thode CORS...');
                    loadDataFromGoogleSheets('cors');
                } else {
                    // Toutes les m√©thodes ont √©chou√©, afficher les options de rechargement
                    showRetryOptions();
                    showError(`Impossible de charger les donn√©es. V√©rifiez:<br>
                    1. Votre connexion internet<br>
                    2. Que le Google Sheet est bien publi√©<br>
                    3. Essayez une m√©thode alternative ci-dessous`);
                }
            }
        }

        function showRetryOptions() {
            document.getElementById('retryOptions').style.display = 'block';
        }

        function processCSVData(csvText) {
            try {
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('Le fichier CSV est vide');
                }
                
                const lines = parseCSV(csvText);
                
                if (!lines || lines.length < 5) {
                    throw new Error('Format de donn√©es invalide');
                }
                
                headers = lines[3] || [];
                sheetData = lines.slice(4).filter(row => 
                    row && row.some(cell => cell && cell.trim() !== '')
                );
                
                console.log(`üìä ${sheetData.length} lignes de donn√©es charg√©es`);
                
                extractDatesWithData();
                renderCalendar();
                displayGlobalStats();
                
            } catch (error) {
                console.error('‚ùå Erreur de traitement:', error);
                showError(`Erreur de traitement des donn√©es: ${error.message}`);
                showRetryOptions();
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function parseCSV(csvText) {
            const lines = [];
            let currentLine = [];
            let currentField = '';
            let inQuotes = false;
            
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentLine.push(currentField);
                    currentField = '';
                } else if (char === '\n' && !inQuotes) {
                    currentLine.push(currentField);
                    lines.push(currentLine);
                    currentLine = [];
                    currentField = '';
                } else if (char === '\r') {
                    continue;
                } else {
                    currentField += char;
                }
            }
            
            if (currentField !== '' || currentLine.length > 0) {
                currentLine.push(currentField);
                lines.push(currentLine);
            }
            
            return lines;
        }
        
        function extractDatesWithData() {
            datesWithData = [];
            
            sheetData.forEach((row, index) => {
                const dateStr = row[0] || '';
                if (dateStr && dateStr.trim() !== '') {
                    const date = parseDate(dateStr);
                    if (date) {
                        datesWithData.push({
                            date: date,
                            dateStr: dateStr,
                            localite: row[1] || '',
                            pays: row[2] || '',
                            rowIndex: index
                        });
                    }
                }
            });
            
            datesWithData.sort((a, b) => a.date - b.date);
            console.log(`üìÖ ${datesWithData.length} dates avec donn√©es trouv√©es`);
        }
        
        function parseDate(dateStr) {
            const formats = [
                'DD/MM/YYYY',
                'DD-MM-YYYY', 
                'YYYY-MM-DD',
                'MM/DD/YYYY'
            ];
            
            for (const format of formats) {
                const date = parseDateWithFormat(dateStr, format);
                if (date && !isNaN(date.getTime())) {
                    return date;
                }
            }
            
            const nativeDate = new Date(dateStr);
            if (!isNaN(nativeDate.getTime())) {
                return nativeDate;
            }
            
            console.warn(`Impossible de parser la date: ${dateStr}`);
            return null;
        }
        
        function parseDateWithFormat(dateStr, format) {
            const parts = dateStr.split(/[/\-.]/);
            const formatParts = format.split(/[/\-.]/);
            
            if (parts.length !== 3) return null;
            
            let day, month, year;
            
            for (let i = 0; i < 3; i++) {
                if (formatParts[i] === 'DD') day = parseInt(parts[i], 10);
                else if (formatParts[i] === 'MM') month = parseInt(parts[i], 10) - 1;
                else if (formatParts[i] === 'YYYY') year = parseInt(parts[i], 10);
            }
            
            if (day && month !== undefined && year) {
                return new Date(year, month, day);
            }
            
            return null;
        }
        
        function formatDateForDisplay(date) {
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
            
            const dayName = days[date.getDay()];
            const day = date.getDate().toString().padStart(2, '0');
            const month = months[date.getMonth()];
            const year = date.getFullYear().toString().slice(-2);
            
            return `${dayName} ${day}-${month}-${year}`;
        }
        
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            
            currentMonthElement.textContent = currentDate.toLocaleDateString('fr-FR', {
                month: 'long',
                year: 'numeric'
            });
            
            calendarGrid.innerHTML = '';
            
            const daysOfWeek = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            daysOfWeek.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            let firstDayOfWeek = firstDayOfMonth.getDay();
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            const prevMonthLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = prevMonthLastDay - i;
                calendarGrid.appendChild(day);
            }
            
            for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                day.innerHTML = `<div>${i}</div>`;
                
                const dateToCheck = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                const dateData = datesWithData.find(item => 
                    item.date.getDate() === dateToCheck.getDate() &&
                    item.date.getMonth() === dateToCheck.getMonth() &&
                    item.date.getFullYear() === dateToCheck.getFullYear()
                );
                
                if (dateData) {
                    day.classList.add('has-data');
                    const dateInfo = document.createElement('div');
                    dateInfo.className = 'date-info';
                    if (dateData.localite) {
                        dateInfo.innerHTML += `<div class="localite">${dateData.localite}</div>`;
                    }
                    if (dateData.pays) {
                        dateInfo.innerHTML += `<div class="pays">${dateData.pays}</div>`;
                    }
                    day.appendChild(dateInfo);
                }
                
                if (selectedDate && 
                    selectedDate.getDate() === i &&
                    selectedDate.getMonth() === currentDate.getMonth() &&
                    selectedDate.getFullYear() === currentDate.getFullYear()) {
                    day.classList.add('selected');
                }
                
                day.addEventListener('click', () => {
                    selectDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), i));
                });
                
                calendarGrid.appendChild(day);
            }
            
            const totalCells = 42;
            const daysInCalendar = firstDayOfWeek + lastDayOfMonth.getDate();
            const nextMonthDays = totalCells - daysInCalendar;
            
            for (let i = 1; i <= nextMonthDays; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = i;
                calendarGrid.appendChild(day);
            }
        }
        
        function selectDate(date) {
            selectedDate = date;
            renderCalendar();
            
            const matchingRows = findDataByDate(date);
            displayResults(matchingRows, `Donn√©es financi√®res du ${formatDateForDisplay(date)}`);
        }
        
        function findDataByDate(date) {
            return sheetData.filter((row, index) => {
                const rowDateStr = row[0] || '';
                const rowDate = parseDate(rowDateStr);
                
                if (rowDate) {
                    return rowDate.getDate() === date.getDate() &&
                           rowDate.getMonth() === date.getMonth() &&
                           rowDate.getFullYear() === date.getFullYear();
                }
                
                return false;
            });
        }
        
        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        function handleSearch(event) {
            if (event) event.preventDefault();
            
            const searchValue = document.getElementById('searchText').value.trim();
            currentSearchTerm = searchValue;
            
            if (!searchValue) {
                alert('Veuillez entrer un mot ou une phrase pour la recherche');
                return;
            }
            
            if (sheetData.length === 0) {
                alert('Aucune donn√©e charg√©e');
                return;
            }
            
            const results = searchData(searchValue);
            displayResults(results, searchValue);
        }
        
        function showAllData() {
            if (sheetData.length === 0) {
                alert('Aucune donn√©e charg√©e');
                return;
            }
            
            currentSearchTerm = '';
            displayResults(sheetData, 'Toutes les donn√©es financi√®res');
        }
        
        function searchData(searchValue) {
            const searchLower = searchValue.toLowerCase();
            
            return sheetData.filter(row => {
                return row.some(cell => {
                    const cellValue = String(cell).toLowerCase();
                    return cellValue.includes(searchLower);
                });
            });
        }

        function cleanNumber(value) {
            if (!value || value === '') return '0';
            return String(value).replace(/[^\d,.-]/g, '').replace(',', '.');
        }

        function parseFinancialValue(value) {
            const cleaned = cleanNumber(value);
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        }

        function formatNumberWithUnit(value, currency) {
            if (value === 0) return '0';
            const units = {
                'Ariary': 'Ar',
                'Euro': '‚Ç¨',
                'Franc Suisse': 'CHF',
                'Livre': '¬£',
                'Banque Euro': '‚Ç¨'
            };
            return `${new Intl.NumberFormat('fr-FR').format(value)} ${units[currency]}`;
        }

        function formatFinancialData(row) {
            const columnMapping = {
                'Ariary': {
                    'Ventes': 3,
                    'Collecte': 4,
                    'Don': 5,
                    'D√©penses': 6
                },
                'Euro': {
                    'Ventes': 7,
                    'Collecte': 8,
                    'Don': 9,
                    'D√©penses': 10
                },
                'Franc Suisse': {
                    'Ventes': 11,
                    'Collecte': 12,
                    'Don': 13,
                    'D√©penses': 14
                },
                'Livre': {
                    'Ventes': 15,
                    'Collecte': 16,
                    'Don': 17,
                    'D√©penses': 18
                },
                'Banque Euro': {
                    'Ventes': 19,
                    'Collecte': 20,
                    'Don': 21,
                    'D√©penses': 22
                }
            };

            let html = '<table class="financial-table">';
            
            html += '<tr><th>Cat√©gorie</th>';
            Object.keys(columnMapping).forEach(currency => {
                html += `<th>${currency}</th>`;
            });
            html += '</tr>';
            
            const categories = ['Ventes', 'Collecte', 'Don', 'D√©penses'];
            categories.forEach(category => {
                html += `<tr><td class="category">${category}</td>`;
                Object.keys(columnMapping).forEach(currency => {
                    const colIndex = columnMapping[currency][category];
                    const value = row[colIndex] || '0';
                    const numericValue = parseFinancialValue(value);
                    html += `<td>${formatNumberWithUnit(numericValue, currency)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '<tr class="recettes-row"><td class="category">RECETTES TOTALES</td>';
            Object.keys(columnMapping).forEach(currency => {
                const cols = columnMapping[currency];
                const ventes = parseFinancialValue(row[cols['Ventes']] || '0');
                const collecte = parseFinancialValue(row[cols['Collecte']] || '0');
                const don = parseFinancialValue(row[cols['Don']] || '0');
                const recettes = ventes + collecte + don;
                html += `<td>${formatNumberWithUnit(recettes, currency)}</td>`;
            });
            html += '</tr>';
            
            html += '<tr class="depenses-row"><td class="category">DEPENSES TOTALES</td>';
            Object.keys(columnMapping).forEach(currency => {
                const cols = columnMapping[currency];
                const depenses = parseFinancialValue(row[cols['D√©penses']] || '0');
                html += `<td>${formatNumberWithUnit(depenses, currency)}</td>`;
            });
            html += '</tr>';
            
            html += '<tr class="difference-row"><td class="category">DIFFERENCE</td>';
            Object.keys(columnMapping).forEach(currency => {
                const cols = columnMapping[currency];
                const ventes = parseFinancialValue(row[cols['Ventes']] || '0');
                const collecte = parseFinancialValue(row[cols['Collecte']] || '0');
                const don = parseFinancialValue(row[cols['Don']] || '0');
                const depenses = parseFinancialValue(row[cols['D√©penses']] || '0');
                const difference = ventes + collecte + don - depenses;
                html += `<td>${formatNumberWithUnit(difference, currency)}</td>`;
            });
            html += '</tr>';
            
            html += '</table>';
            
            return html;
        }

        function displayGlobalStats() {
            const statsSection = document.getElementById('globalStats');
            
            if (sheetData.length === 0) {
                statsSection.innerHTML = '<p>Aucune donn√©e disponible</p>';
                return;
            }

            const columnMapping = {
                'Ariary': {
                    'Ventes': 3,
                    'Collecte': 4,
                    'Don': 5,
                    'D√©penses': 6
                },
                'Euro': {
                    'Ventes': 7,
                    'Collecte': 8,
                    'Don': 9,
                    'D√©penses': 10
                },
                'Franc Suisse': {
                    'Ventes': 11,
                    'Collecte': 12,
                    'Don': 13,
                    'D√©penses': 14
                },
                'Livre': {
                    'Ventes': 15,
                    'Collecte': 16,
                    'Don': 17,
                    'D√©penses': 18
                },
                'Banque Euro': {
                    'Ventes': 19,
                    'Collecte': 20,
                    'Don': 21,
                    'D√©penses': 22
                }
            };

            const globalTotals = {};
            Object.keys(columnMapping).forEach(currency => {
                globalTotals[currency] = {
                    'Ventes': 0,
                    'Collecte': 0,
                    'Don': 0,
                    'D√©penses': 0
                };
            });

            sheetData.forEach(row => {
                Object.keys(columnMapping).forEach(currency => {
                    const cols = columnMapping[currency];
                    globalTotals[currency]['Ventes'] += parseFinancialValue(row[cols['Ventes']] || '0');
                    globalTotals[currency]['Collecte'] += parseFinancialValue(row[cols['Collecte']] || '0');
                    globalTotals[currency]['Don'] += parseFinancialValue(row[cols['Don']] || '0');
                    globalTotals[currency]['D√©penses'] += parseFinancialValue(row[cols['D√©penses']] || '0');
                });
            });

            let html = '<table class="financial-table">';
            
            html += '<tr><th>Cat√©gorie</th>';
            Object.keys(columnMapping).forEach(currency => {
                html += `<th>${currency}</th>`;
            });
            html += '</tr>';
            
            const categories = ['Ventes', 'Collecte', 'Don', 'D√©penses'];
            categories.forEach(category => {
                html += `<tr><td class="category">${category}</td>`;
                Object.keys(columnMapping).forEach(currency => {
                    const value = globalTotals[currency][category];
                    html += `<td>${formatNumberWithUnit(value, currency)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '<tr class="recettes-row"><td class="category">RECETTES TOTALES</td>';
            Object.keys(columnMapping).forEach(currency => {
                const recettes = globalTotals[currency]['Ventes'] + globalTotals[currency]['Collecte'] + globalTotals[currency]['Don'];
                html += `<td>${formatNumberWithUnit(recettes, currency)}</td>`;
            });
            html += '</tr>';
            
            html += '<tr class="depenses-row"><td class="category">DEPENSES TOTALES</td>';
            Object.keys(columnMapping).forEach(currency => {
                const depenses = globalTotals[currency]['D√©penses'];
                html += `<td>${formatNumberWithUnit(depenses, currency)}</td>`;
            });
            html += '</tr>';
            
            html += '<tr class="difference-row"><td class="category">DIFFERENCE</td>';
            Object.keys(columnMapping).forEach(currency => {
                const recettes = globalTotals[currency]['Ventes'] + globalTotals[currency]['Collecte'] + globalTotals[currency]['Don'];
                const depenses = globalTotals[currency]['D√©penses'];
                const difference = recettes - depenses;
                html += `<td>${formatNumberWithUnit(difference, currency)}</td>`;
            });
            html += '</tr>';
            
            html += '</table>';
            
            statsSection.innerHTML = html;
        }
        
        function displayResults(results, searchTerm) {
            const resultsSection = document.getElementById('resultsSection');
            const resultContent = document.getElementById('resultContent');
            const resultTitle = document.getElementById('resultTitle');
            
            if (results.length === 0) {
                resultContent.innerHTML = `
                    <div class="no-results">
                        <h3>‚ùå Aucune donn√©e trouv√©e</h3>
                        <p>Aucune donn√©e financi√®re ne correspond √† votre recherche "${searchTerm}"</p>
                    </div>
                `;
            } else {
                let html = `
                    <div class="search-stats">
                        <strong>${results.length} ligne(s) de donn√©es trouv√©e(s)</strong> pour : "${searchTerm}"
                    </div>
                `;
                
                results.forEach((row, index) => {
                    const dateStr = row[0] || 'Date non sp√©cifi√©e';
                    const localite = row[1] || '';
                    const pays = row[2] || '';
                    
                    html += `
                        <div class="pv-item">
                            <div class="pv-header">
                                <h2>üí∞ Donn√©es Financi√®res</h2>
                                <h3 class="pv-title">
                                    ${formatDateForDisplay(parseDate(dateStr))}
                                </h3>
                            </div>
                            <div style="padding: 20px;">
                    `;
                    
                    if (localite || pays) {
                        html += `
                            <div class="location-info">
                                <strong>üìç Localisation :</strong> 
                                ${localite ? `<span class="localite">${localite}</span>` : ''}
                                ${pays ? ` - <span class="pays">${pays}</span>` : ''}
                            </div>
                        `;
                    }
                    
                    html += formatFinancialData(row);
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                resultContent.innerHTML = html;
            }
            
            resultTitle.textContent = `R√©sultats pour "${searchTerm}"`;
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeResults() {
            document.getElementById('resultsSection').style.display = 'none';
            currentSearchTerm = '';
        }

        function showError(message) {
            const searchSection = document.querySelector('.search-section');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = message;
            searchSection.appendChild(errorDiv);
        }

        function clearErrorMessages() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());
        }
        
        // NOUVELLE FONCTION MODIFI√âE : Affichage du r√©capitulatif par pays
        function showCountrySummary(pays) {
            console.log(`Affichage du r√©capitulatif pour ${pays}`);
            
            // Filtrer les donn√©es par pays
            const countryData = sheetData.filter(row => {
                const rowPays = row[2] || '';
                return rowPays.toUpperCase() === pays.toUpperCase();
            });
            
            if (countryData.length === 0) {
                alert(`Aucune donn√©e trouv√©e pour ${pays}`);
                return;
            }
            
            // D√©terminer la devise principale en fonction du pays
            let mainCurrency = 'Euro'; // Par d√©faut
            let mainCurrencyLabel = 'Euro';
            
            if (pays.toUpperCase() === 'SUISSE') {
                mainCurrency = 'Franc Suisse';
                mainCurrencyLabel = 'Franc Suisse';
            } else if (pays.toUpperCase() === 'ANGLETERRE' || pays.toUpperCase() === 'WALES') {
                mainCurrency = 'Livre';
                mainCurrencyLabel = 'Livre Sterling';
            }
            
            // D√©terminer si on doit afficher la colonne Euro (pas pour les pays qui utilisent d√©j√† l'euro)
            const showEuroColumn = !['FRANCE', 'ALLEMAGNE', 'BELGIQUE'].includes(pays.toUpperCase());
            
            // Colonnes pour chaque cat√©gorie selon la devise
            const columnMapping = {
                'Ariary': {
                    'Ventes': 3,
                    'Collecte': 4,
                    'Don': 5,
                    'D√©penses': 6
                },
                'Euro': {
                    'Ventes': 7,
                    'Collecte': 8,
                    'Don': 9,
                    'D√©penses': 10
                },
                'Franc Suisse': {
                    'Ventes': 11,
                    'Collecte': 12,
                    'Don': 13,
                    'D√©penses': 14
                },
                'Livre': {
                    'Ventes': 15,
                    'Collecte': 16,
                    'Don': 17,
                    'D√©penses': 18
                },
                'Banque Euro': {
                    'Ventes': 19,
                    'Collecte': 20,
                    'Don': 21,
                    'D√©penses': 22
                }
            };
            
            // Cr√©er le tableau r√©capitulatif avec conteneur de d√©filement
            let html = `
                <div class="search-stats">
                    <strong>${countryData.length} date(s) trouv√©e(s)</strong> pour : ${pays}
                </div>
                <div class="scroll-hint">Faites d√©filer horizontalement pour voir toutes les colonnes</div>
                <div class="table-scroll-container">
                    <table class="country-summary-table">
                        <thead>
                            <tr>
                                <th rowspan="2">Date</th>
                                <th colspan="4" class="currency-header">${mainCurrencyLabel}</th>
            `;
            
            // Ajouter la colonne Euro seulement si n√©cessaire
            if (showEuroColumn) {
                html += `<th colspan="4" class="currency-header">Euro</th>`;
            }
            
            html += `
                                <th colspan="4" class="currency-header">Banque Euro</th>
                            </tr>
                            <tr class="sub-header">
                                <th>Ventes</th>
                                <th>Collecte</th>
                                <th>Don</th>
                                <th>D√©penses</th>
            `;
            
            // Ajouter les sous-en-t√™tes Euro seulement si n√©cessaire
            if (showEuroColumn) {
                html += `
                                <th>Ventes</th>
                                <th>Collecte</th>
                                <th>Don</th>
                                <th>D√©penses</th>
                `;
            }
            
            html += `
                                <th>Ventes</th>
                                <th>Collecte</th>
                                <th>Don</th>
                                <th>D√©penses</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Variables pour les totaux
            let totalMainVentes = 0, totalMainCollecte = 0, totalMainDon = 0, totalMainDepenses = 0;
            let totalEuroVentes = 0, totalEuroCollecte = 0, totalEuroDon = 0, totalEuroDepenses = 0;
            let totalBanqueVentes = 0, totalBanqueCollecte = 0, totalBanqueDon = 0, totalBanqueDepenses = 0;
            
            // Ajouter chaque ligne de donn√©es
            countryData.forEach(row => {
                const dateStr = row[0] || '';
                
                // Donn√©es pour la devise principale
                const mainVentes = parseFinancialValue(row[columnMapping[mainCurrency]['Ventes']] || '0');
                const mainCollecte = parseFinancialValue(row[columnMapping[mainCurrency]['Collecte']] || '0');
                const mainDon = parseFinancialValue(row[columnMapping[mainCurrency]['Don']] || '0');
                const mainDepenses = parseFinancialValue(row[columnMapping[mainCurrency]['D√©penses']] || '0');
                
                // Donn√©es pour Euro (seulement si affich√©es)
                const euroVentes = showEuroColumn ? parseFinancialValue(row[columnMapping['Euro']['Ventes']] || '0') : 0;
                const euroCollecte = showEuroColumn ? parseFinancialValue(row[columnMapping['Euro']['Collecte']] || '0') : 0;
                const euroDon = showEuroColumn ? parseFinancialValue(row[columnMapping['Euro']['Don']] || '0') : 0;
                const euroDepenses = showEuroColumn ? parseFinancialValue(row[columnMapping['Euro']['D√©penses']] || '0') : 0;
                
                // Donn√©es pour Banque Euro
                const banqueVentes = parseFinancialValue(row[columnMapping['Banque Euro']['Ventes']] || '0');
                const banqueCollecte = parseFinancialValue(row[columnMapping['Banque Euro']['Collecte']] || '0');
                const banqueDon = parseFinancialValue(row[columnMapping['Banque Euro']['Don']] || '0');
                const banqueDepenses = parseFinancialValue(row[columnMapping['Banque Euro']['D√©penses']] || '0');
                
                // Ajouter aux totaux
                totalMainVentes += mainVentes;
                totalMainCollecte += mainCollecte;
                totalMainDon += mainDon;
                totalMainDepenses += mainDepenses;
                
                if (showEuroColumn) {
                    totalEuroVentes += euroVentes;
                    totalEuroCollecte += euroCollecte;
                    totalEuroDon += euroDon;
                    totalEuroDepenses += euroDepenses;
                }
                
                totalBanqueVentes += banqueVentes;
                totalBanqueCollecte += banqueCollecte;
                totalBanqueDon += banqueDon;
                totalBanqueDepenses += banqueDepenses;
                
                html += `
                    <tr>
                        <td class="date-cell">${dateStr}</td>
                        <td>${formatNumberWithUnit(mainVentes, mainCurrency)}</td>
                        <td>${formatNumberWithUnit(mainCollecte, mainCurrency)}</td>
                        <td>${formatNumberWithUnit(mainDon, mainCurrency)}</td>
                        <td>${formatNumberWithUnit(mainDepenses, mainCurrency)}</td>
                `;
                
                // Ajouter les colonnes Euro seulement si n√©cessaires
                if (showEuroColumn) {
                    html += `
                        <td>${formatNumberWithUnit(euroVentes, 'Euro')}</td>
                        <td>${formatNumberWithUnit(euroCollecte, 'Euro')}</td>
                        <td>${formatNumberWithUnit(euroDon, 'Euro')}</td>
                        <td>${formatNumberWithUnit(euroDepenses, 'Euro')}</td>
                    `;
                }
                
                html += `
                        <td>${formatNumberWithUnit(banqueVentes, 'Banque Euro')}</td>
                        <td>${formatNumberWithUnit(banqueCollecte, 'Banque Euro')}</td>
                        <td>${formatNumberWithUnit(banqueDon, 'Banque Euro')}</td>
                        <td>${formatNumberWithUnit(banqueDepenses, 'Banque Euro')}</td>
                    </tr>
                `;
            });
            
            // Ajouter la ligne de total
            html += `
                <tr class="total-row">
                    <td class="date-cell">TOTAL</td>
                    <td>${formatNumberWithUnit(totalMainVentes, mainCurrency)}</td>
                    <td>${formatNumberWithUnit(totalMainCollecte, mainCurrency)}</td>
                    <td>${formatNumberWithUnit(totalMainDon, mainCurrency)}</td>
                    <td>${formatNumberWithUnit(totalMainDepenses, mainCurrency)}</td>
            `;
            
            // Ajouter les totaux Euro seulement si affich√©s
            if (showEuroColumn) {
                html += `
                    <td>${formatNumberWithUnit(totalEuroVentes, 'Euro')}</td>
                    <td>${formatNumberWithUnit(totalEuroCollecte, 'Euro')}</td>
                    <td>${formatNumberWithUnit(totalEuroDon, 'Euro')}</td>
                    <td>${formatNumberWithUnit(totalEuroDepenses, 'Euro')}</td>
                `;
            }
            
            html += `
                    <td>${formatNumberWithUnit(totalBanqueVentes, 'Banque Euro')}</td>
                    <td>${formatNumberWithUnit(totalBanqueCollecte, 'Banque Euro')}</td>
                    <td>${formatNumberWithUnit(totalBanqueDon, 'Banque Euro')}</td>
                    <td>${formatNumberWithUnit(totalBanqueDepenses, 'Banque Euro')}</td>
                </tr>
            `;
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            // Afficher les r√©sultats
            const resultsSection = document.getElementById('resultsSection');
            const resultContent = document.getElementById('resultContent');
            const resultTitle = document.getElementById('resultTitle');
            
            resultContent.innerHTML = html;
            resultTitle.textContent = `R√©capitulatif financier pour ${pays}`;
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
