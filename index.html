<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAPPORT FINANCIER TOURN√âE 2026</title>
    <style>
        :root {
            --primary-color: #2980b9;
            --secondary-color: #2c3e50;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --text-color: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --background-color: #f0f2f5;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 50px 20px 40px;
            background: linear-gradient(135deg, #1a2a6c 0%, #2c3e50 50%, #4a235a 100%);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            border: 2px solid #3498db;
        }
        
        .currency-decoration {
            position: absolute;
            font-size: 2.5em;
            z-index: 1;
            animation: float 6s ease-in-out infinite;
        }
        
        .currency-decoration.ariary {
            top: 20px;
            left: 20px;
            animation-delay: 0s;
        }
        
        .currency-decoration.euro {
            top: 20px;
            right: 20px;
            animation-delay: 1s;
        }
        
        .currency-decoration.franc {
            bottom: 20px;
            left: 20px;
            animation-delay: 2s;
        }
        
        .currency-decoration.livre {
            bottom: 20px;
            right: 20px;
            animation-delay: 3s;
        }
        
        .currency-decoration.banque {
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            animation-delay: 4s;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }
        
        .currency-badges {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }
        
        .currency-badge {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
        }
        
        h1 {
            color: white;
            margin-bottom: 15px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        header p {
            color: #ecf0f1;
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .stats-section {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }
        
        .stats-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .search-section {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }
        
        .search-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 250px;
            position: relative;
        }
        
        .calendar-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .calendar-scroll-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 20px;
            border: 1px solid #e1e1e1;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 15px;
        }
        
        .calendar {
            min-width: 600px;
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            min-width: 600px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 8px;
            background-color: var(--light-color);
            border-radius: 4px;
            min-width: 70px;
        }
        
        .calendar-day {
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
            position: relative;
            min-height: 80px;
            min-width: 70px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .calendar-day:hover {
            background-color: var(--light-color);
        }
        
        .calendar-day.selected {
            background-color: var(--primary-color);
            color: white;
        }
        
        .calendar-day.has-data {
            font-weight: bold;
        }
        
        .calendar-day.other-month {
            color: #ccc;
        }
        
        .date-info {
            font-size: 0.7em;
            line-height: 1.2;
        }
        
        .localite {
            color: #2980b9;
            font-weight: bold;
        }
        
        .pays {
            color: #e74c3c;
            font-weight: bold;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }
        
        input, select, button {
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            width: 100%;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
            min-width: 150px;
        }
        
        button:hover {
            background-color: #1f6391;
        }
        
        button.secondary {
            background-color: #7f8c8d;
        }
        
        button.secondary:hover {
            background-color: #6c7a7d;
        }
        
        .external-button.locked {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            cursor: not-allowed;
            opacity: 0.7;
            position: relative;
        }
        
        .external-button.locked:hover {
            transform: none;
            box-shadow: none;
        }
        
        .external-button.locked::after {
            content: "üîí";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
        }
        
        .source-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .source-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .source-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .modal-content h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
        }
        
        .password-input {
            margin: 20px 0;
        }
        
        .password-input input {
            text-align: center;
            letter-spacing: 2px;
            font-family: monospace;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .modal-buttons button {
            flex: 1;
            min-width: 120px;
        }
        
        .error-message-password {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }
        
        .financial-table-container {
            width: 100%;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e1e1e1;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .financial-table {
            width: auto;
            min-width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin: 0;
        }
        
        .financial-table th {
            background: var(--light-color);
            color: var(--primary-color);
            font-weight: bold;
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            white-space: nowrap;
        }
        
        .financial-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: right;
            white-space: nowrap;
        }
        
        .financial-table .category {
            background: #f8f9fa;
            font-weight: bold;
            text-align: left;
            position: sticky;
            left: 0;
            z-index: 1;
        }
        
        .financial-table .recettes-row {
            background: #d4edda;
            font-weight: bold;
        }
        
        .financial-table .depenses-row {
            background: #f8d7da;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .financial-table .depenses-row:hover {
            background-color: #f5b7b1;
        }
        
        .financial-table .don-row {
            background: #fff3cd;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .financial-table .don-row:hover {
            background-color: #ffe69c;
        }
        
        .financial-table .fonds-propre-row {
            background: #fff3cd;
            font-weight: bold;
        }
        
        .financial-table .fonds-propre-row td {
            font-weight: 900 !important;
            color: #e67e22 !important;
            font-size: 1.1em;
        }
        
        .financial-table .autres-header {
            background: #ffeaa7;
            font-weight: bold;
            text-align: center;
        }
        
        .financial-table .ressource-row {
            background: #e8f0fe;
        }
        
        .financial-table .depense-row {
            background: #ffe6f0;
        }
        
        .financial-table .emprunt-row {
            background: #e8f0fe;
            cursor: pointer;
        }
        
        .financial-table .pret-row {
            background: #f0e6ff;
            cursor: pointer;
        }
        
        .financial-table .transfert-row {
            background: #ffe6f0;
            cursor: pointer;
        }
        
        .financial-table .change-row {
            background: #fff0e6;
            cursor: pointer;
        }
        
        .financial-table .emprunt-row:hover,
        .financial-table .pret-row:hover,
        .financial-table .transfert-row:hover,
        .financial-table .change-row:hover {
            filter: brightness(0.95);
        }
        
        .financial-table .en-main-row {
            background: #b2f0e6;
            font-weight: bold;
            border-top: 3px solid #00b894;
            border-bottom: 3px solid #00b894;
        }
        
        .financial-table .en-main-row td {
            font-weight: 900;
        }
        
        .details-bulle {
            position: fixed;
            background: white;
            border: 2px solid #e74c3c;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 20px;
            z-index: 2000;
            min-width: 400px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            display: none;
        }
        
        .details-bulle h3 {
            color: #e74c3c;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e74c3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .details-bulle .close-bulle {
            cursor: pointer;
            font-size: 20px;
            color: #7f8c8d;
        }
        
        .details-bulle .close-bulle:hover {
            color: #e74c3c;
        }
        
        .details-bulle table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        
        .details-bulle th {
            background: #e74c3c;
            color: white;
            padding: 10px;
            text-align: center;
        }
        
        .details-bulle td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: right;
        }
        
        .details-bulle td:first-child {
            text-align: left;
            font-weight: bold;
            background: #f8f9fa;
        }
        
        .details-bulle .total-row {
            background: #d1ecf1;
            font-weight: bold;
        }
        
        .details-bulle-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            display: none;
        }
        
        .results-section {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-top: 30px;
        }
        
        .result-header {
            background-color: var(--secondary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-content {
            padding: 20px;
        }
        
        .pv-item {
            margin-bottom: 40px;
            border: 1px solid #e1e1e1;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .pv-header {
            background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 50%, #c8e6c9 100%);
            color: #2e7d32;
            padding: 25px;
            border-bottom: 3px solid #4CAF50;
        }
        
        .pv-title {
            color: #2e7d32;
            font-weight: bold;
            margin-top: 0;
            font-size: 1.6em;
        }
        
        .location-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border-left: 4px solid #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        .error-message {
            background-color: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        
        .retry-options {
            background: #fff3cd;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 10px 0;
            border-left: 4px solid #ffc107;
            display: none;
        }
        
        .retry-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .retry-buttons button {
            flex: 1;
            min-width: 120px;
        }
        
        .country-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .country-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
            max-width: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .country-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .country-button.suisse {
            background-color: #e74c3c;
        }
        
        .country-button.france {
            background-color: #2980b9;
        }
        
        .country-button.allemagne {
            background-color: #2c3e50;
        }
        
        .country-button.belgique {
            background-color: #f39c12;
        }
        
        .country-button.wales {
            background-color: #27ae60;
        }
        
        .country-button.angleterre {
            background-color: #9b59b6;
        }
        
        .external-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 30px 0 20px 0;
            justify-content: center;
        }
        
        .external-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s;
            flex: 1;
            min-width: 200px;
            max-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .external-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        
        .external-button.rubriques {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .external-button.recap {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .table-scroll-container {
            width: 100%;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid #e1e1e1;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .country-summary-table {
            width: auto;
            min-width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            margin: 0;
        }
        
        .country-summary-table th {
            background: #2c3e50;
            color: white;
            font-weight: bold;
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
            white-space: nowrap;
        }
        
        .country-summary-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: right;
            white-space: nowrap;
        }
        
        .country-summary-table .date-cell {
            text-align: left;
            font-weight: bold;
            position: sticky;
            left: 0;
            background: #f8f9fa;
            z-index: 1;
        }
        
        .country-summary-table .total-row {
            background: #d1ecf1;
            font-weight: bold;
        }
        
        .country-summary-table .currency-column {
            background: #f8f9fa;
        }
        
        .country-summary-table .currency-header {
            background: #3498db;
            color: white;
            font-size: 1.1em;
        }
        
        .country-summary-table .sub-header {
            background: #2980b9;
            color: white;
        }
        
        .scroll-hint {
            text-align: center;
            color: #7f8c8d;
            font-size: 14px;
            margin: 10px 0;
            display: none;
        }
        
        .scroll-hint::after {
            content: "‚Üê ‚Üí";
            display: block;
            font-weight: bold;
            font-size: 16px;
            margin-top: 5px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .financial-table {
                font-size: 12px;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 5px;
                min-width: 60px;
            }
            
            .calendar-day-header {
                min-width: 60px;
                padding: 6px;
            }
            
            .calendar-grid {
                min-width: 500px;
                gap: 3px;
            }
            
            .calendar {
                min-width: 500px;
                padding: 10px;
            }
            
            .retry-buttons {
                flex-direction: column;
            }
            
            .country-buttons {
                flex-direction: row;
                align-items: center;
            }
            
            .country-button {
                max-width: calc(50% - 10px);
                min-width: 140px;
            }
            
            .external-buttons {
                flex-direction: row;
                align-items: center;
            }
            
            .external-button {
                max-width: calc(50% - 10px);
                min-width: 180px;
            }
            
            .source-button {
                max-width: calc(50% - 10px);
                min-width: 180px;
            }
            
            .country-summary-table {
                font-size: 12px;
            }
            
            .country-summary-table th,
            .country-summary-table td {
                padding: 8px 6px;
            }
            
            .scroll-hint {
                display: block;
            }
            
            .currency-decoration {
                font-size: 1.8em;
            }
            
            .currency-decoration.ariary {
                top: 10px;
                left: 10px;
            }
            
            .currency-decoration.euro {
                top: 10px;
                right: 10px;
            }
            
            .currency-decoration.franc {
                bottom: 10px;
                left: 10px;
            }
            
            .currency-decoration.livre {
                bottom: 10px;
                right: 10px;
            }
            
            .currency-decoration.banque {
                left: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            header p {
                font-size: 1em;
            }
            
            .details-bulle {
                min-width: 300px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .country-summary-table {
                font-size: 11px;
            }
            
            .country-summary-table th,
            .country-summary-table td {
                padding: 6px 4px;
            }
            
            .currency-decoration {
                font-size: 1.5em;
            }
            
            h1 {
                font-size: 1.7em;
            }
            
            .calendar-grid {
                min-width: 450px;
            }
            
            .calendar {
                min-width: 450px;
            }
            
            .calendar-day {
                min-width: 55px;
                min-height: 55px;
            }
            
            .calendar-day-header {
                min-width: 55px;
            }
            
            .country-button {
                max-width: 100%;
                min-width: 100%;
            }
            
            .external-button, .source-button {
                max-width: 100%;
                min-width: 100%;
            }
            
            .details-bulle {
                min-width: 280px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="currency-decoration ariary">üá≤üá¨</div>
            <div class="currency-decoration euro">üí∂</div>
            <div class="currency-decoration franc">üá®üá≠</div>
            <div class="currency-decoration livre">üí∑</div>
            <div class="currency-decoration banque">üè¶</div>
            
            <div class="header-content">
                <h1>üí∞ RAPPORT FINANCIER TOURN√âE 2026</h1>
                <p>Navigation par date et recherche dans les donn√©es financi√®res</p>
                
                <div class="currency-badges">
                    <div class="currency-badge">üá≤üá¨ Ariary</div>
                    <div class="currency-badge">üí∂ Euro</div>
                    <div class="currency-badge">üá®üá≠ Franc Suisse</div>
                    <div class="currency-badge">üí∑ Livre Sterling</div>
                    <div class="currency-badge">üè¶ Banque Euro</div>
                </div>
            </div>
        </header>
        
        <section class="stats-section" id="statsSection">
            <h2>üìä RECAPITULATIF GLOBAL</h2>
            
            <div class="scroll-hint">Faites d√©filer horizontalement pour voir toutes les colonnes</div>
            <div class="financial-table-container">
                <div id="globalStats">
                    <!-- Les statistiques globales seront affich√©es ici -->
                </div>
            </div>
            
            <!-- Nouvelle section pour les boutons externes -->
            <div class="external-buttons">
                <button class="external-button rubriques locked" id="rubriquesButton" onclick="handleProtectedButton('https://nyakotour26-del.github.io/recap_DETAILS/')">
                    üîí Rubriques D√©tails
                </button>
                <button class="external-button recap locked" id="recapButton" onclick="handleProtectedButton('https://nyakotour26-del.github.io/RECAP-GL/')">
                    üîí Recap GL
                </button>
                
                <button class="source-button" id="sourceButton" disabled onclick="showPasswordModal()">
                    üîí Acc√®s Fichier Source
                </button>
            </div>
            
            <h2 style="margin-top: 30px;">üåç R√âCAPITULATIF PAR PAYS</h2>
            <div class="country-buttons" id="countryButtons">
                <button class="country-button suisse" data-pays="SUISSE">üá®üá≠ SUISSE</button>
                <button class="country-button france" data-pays="FRANCE">üá´üá∑ FRANCE</button>
                <button class="country-button allemagne" data-pays="ALLEMAGNE">üá©üá™ ALLEMAGNE</button>
                <button class="country-button belgique" data-pays="BELGIQUE">üáßüá™ BELGIQUE</button>
                <button class="country-button wales" data-pays="WALES">üè¥Û†ÅßÛ†Å¢Û†Å∑Û†Å¨Û†Å≥Û†Åø WALES</button>
                <button class="country-button angleterre" data-pays="ANGLETERRE">üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø ANGLETERRE</button>
            </div>
        </section>
        
        <section class="search-section">
            <form id="searchForm" class="search-form" autocomplete="off">
                <div class="form-group">
                    <label for="searchText">Rechercher un mot ou une phrase :</label>
                    <input type="text" id="searchText" placeholder="Entrez votre recherche..." autocomplete="off">
                </div>
                
                <div class="form-group">
                    <button type="submit">üîç Rechercher</button>
                </div>
            </form>
            
            <div class="retry-options" id="retryOptions">
                <h3>Probl√®me de chargement ?</h3>
                <p>Essayez une autre m√©thode de connexion :</p>
                <div class="retry-buttons">
                    <button id="tryDirect" style="background-color: #3498db;">M√©thode Standard</button>
                    <button id="tryProxy" style="background-color: #9b59b6;">M√©thode Alternative 1</button>
                    <button id="tryCors" style="background-color: #e67e22;">M√©thode Alternative 2</button>
                </div>
            </div>
            
            <div class="calendar-scroll-container">
                <div class="calendar">
                    <div class="calendar-header">
                        <button id="prevMonth" class="secondary">‚óÄ</button>
                        <h3 id="currentMonth"></h3>
                        <button id="nextMonth" class="secondary">‚ñ∂</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Le calendrier sera g√©n√©r√© ici -->
                    </div>
                </div>
            </div>
            
            <button id="showAllButton" style="background-color: #27ae60; margin-top: 15px;">
                üìä Afficher toutes les donn√©es financi√®res
            </button>
        </section>
        
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Chargement des donn√©es depuis Google Sheets...</p>
        </div>

        <section class="results-section" id="resultsSection">
            <div class="result-header">
                <h2 id="resultTitle">R√©sultats de la recherche</h2>
                <button id="closeResults">‚úï Fermer</button>
            </div>
            <div class="result-content" id="resultContent">
                <!-- Les r√©sultats seront affich√©es ici -->
            </div>
        </section>
    </div>

    <!-- Overlay et bulle pour les d√©tails -->
    <div class="details-bulle-overlay" id="detailsOverlay" onclick="hideDetailsBulle()"></div>
    <div class="details-bulle" id="detailsBulle">
        <h3>
            <span id="bulleTitle">D√âTAILS</span>
            <span class="close-bulle" onclick="hideDetailsBulle()">‚úï</span>
        </h3>
        <div id="detailsBulleContent">
            <!-- Le contenu sera g√©n√©r√© dynamiquement -->
        </div>
    </div>

    <div class="modal-overlay" id="passwordModal">
        <div class="modal-content">
            <h3>üîí Acc√®s Prot√©g√©</h3>
            <p>Veuillez entrer le mot de passe pour acc√©der aux fonctionnalit√©s prot√©g√©es :</p>
            
            <div class="password-input">
                <input type="password" id="passwordInput" placeholder="Mot de passe" autocomplete="off">
            </div>
            
            <div class="error-message-password" id="passwordError">
                ‚ùå Mot de passe incorrect. Veuillez r√©essayer.
            </div>
            
            <div class="modal-buttons">
                <button onclick="closePasswordModal()" class="secondary">Annuler</button>
                <button onclick="checkPassword()" style="background-color: #27ae60;">Valider</button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEETS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSrF0hs00W-QvR3v5wxZA1ceGEx4xWR0dJv5kF3zgab6YVV00OehcwxYg-EJfOrMqj4IJnDl649SIkg/pub?gid=106676164&single=true&output=csv';
        const AUTRES_SOURCES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSrF0hs00W-QvR3v5wxZA1ceGEx4xWR0dJv5kF3zgab6YVV00OehcwxYg-EJfOrMqj4IJnDl649SIkg/pub?gid=1910246230&single=true&output=csv';
        const SOURCE_FILE_URL = 'https://docs.google.com/spreadsheets/d/1OrJcM5Sud9KbKqwdFhL3EEX0Rn3EW2B9pl6LEhlQj2g/edit?gid=1011617752#gid=1011617752';
        const CORRECT_PASSWORD = 'finadmin';
        
        let sheetData = [];
        let headers = [];
        let datesWithData = [];
        let currentDate = new Date(2026, 3, 1);
        let selectedDate = null;
        let currentSearchTerm = '';
        let isAuthenticated = false;
        
        // Donn√©es pour les "Autres ressources et depenses"
        let autresSourcesData = {};
        
        // Donn√©es pour les d√©tails d√©penses (B2:G15) avec correction
        let detailsDepensesData = [];
        
        // Nouvelles donn√©es pour les d√©tails don (I3:N4)
        let detailsDonData = [];
        
        // Nouvelles donn√©es pour les bulles emprunt, pr√™t, transfert, change
        let detailsEmpruntData = { montant: [], remboursement: [] };
        let detailsPretData = { montant: [], remboursement: [] };
        let detailsTransfertData = { montant: [], remboursement: [] };
        let detailsChangeData = { montant: [], remboursement: [] };
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchForm').addEventListener('submit', handleSearch);
            document.getElementById('prevMonth').addEventListener('click', prevMonth);
            document.getElementById('nextMonth').addEventListener('click', nextMonth);
            document.getElementById('showAllButton').addEventListener('click', showAllData);
            document.getElementById('closeResults').addEventListener('click', closeResults);
            document.getElementById('tryDirect').addEventListener('click', () => loadDataFromGoogleSheets('direct'));
            document.getElementById('tryProxy').addEventListener('click', () => loadDataFromGoogleSheets('proxy'));
            document.getElementById('tryCors').addEventListener('click', () => loadDataFromGoogleSheets('cors'));
            
            const countryButtons = document.querySelectorAll('.country-button');
            countryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const pays = this.getAttribute('data-pays');
                    showCountrySummary(pays);
                });
            });
            
            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    checkPassword();
                }
            });
            
            loadDataFromGoogleSheets('direct');
            
            lockProtectedButtons();
        });

        function handleProtectedButton(url) {
            if (isAuthenticated) {
                window.open(url, '_blank');
            } else {
                showPasswordModal();
            }
        }

        function lockProtectedButtons() {
            const rubriquesButton = document.getElementById('rubriquesButton');
            const recapButton = document.getElementById('recapButton');
            const sourceButton = document.getElementById('sourceButton');
            
            rubriquesButton.classList.add('locked');
            recapButton.classList.add('locked');
            sourceButton.disabled = true;
            
            rubriquesButton.innerHTML = 'üîí Rubriques D√©tails';
            recapButton.innerHTML = 'üîí Recap GL';
            sourceButton.innerHTML = 'üîí Acc√®s Fichier Source';
        }

        function unlockProtectedButtons() {
            const rubriquesButton = document.getElementById('rubriquesButton');
            const recapButton = document.getElementById('recapButton');
            const sourceButton = document.getElementById('sourceButton');
            
            rubriquesButton.classList.remove('locked');
            recapButton.classList.remove('locked');
            sourceButton.disabled = false;
            
            rubriquesButton.innerHTML = 'üìã Rubriques D√©tails';
            recapButton.innerHTML = 'üìà Recap GL';
            sourceButton.innerHTML = 'üìÅ Acc√®s Fichier Source';
            sourceButton.style.background = 'linear-gradient(135deg, #00b894 0%, #00a085 100%)';
            
            rubriquesButton.onclick = function() {
                window.open('https://nyakotour26-del.github.io/recap_DETAILS/', '_blank');
            };
            
            recapButton.onclick = function() {
                window.open('https://nyakotour26-del.github.io/RECAP-GL/', '_blank');
            };
        }

        function showPasswordModal() {
            document.getElementById('passwordModal').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordInput').focus();
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }

        function checkPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            const enteredPassword = passwordInput.value.trim();
            
            if (enteredPassword === CORRECT_PASSWORD) {
                isAuthenticated = true;
                closePasswordModal();
                unlockProtectedButtons();
                showTemporaryMessage('‚úÖ Acc√®s autoris√© aux fonctionnalit√©s prot√©g√©es', 'success');
                localStorage.setItem('finadmin_authenticated', 'true');
                localStorage.setItem('finadmin_timestamp', Date.now().toString());
            } else {
                passwordError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
                passwordInput.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    passwordInput.style.animation = '';
                }, 500);
            }
        }

        function checkExistingAuthentication() {
            const authenticated = localStorage.getItem('finadmin_authenticated');
            const timestamp = localStorage.getItem('finadmin_timestamp');
            
            if (authenticated === 'true' && timestamp) {
                const now = Date.now();
                const authTime = parseInt(timestamp);
                const hoursSinceAuth = (now - authTime) / (1000 * 60 * 60);
                
                if (hoursSinceAuth < 8) {
                    isAuthenticated = true;
                    unlockProtectedButtons();
                } else {
                    localStorage.removeItem('finadmin_authenticated');
                    localStorage.removeItem('finadmin_timestamp');
                }
            }
        }

        function showTemporaryMessage(message, type) {
            const messageDiv = document.createElement('div');
            messageDiv.textContent = message;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: var(--border-radius);
                color: white;
                font-weight: bold;
                z-index: 1001;
                box-shadow: var(--box-shadow);
                animation: slideIn 0.3s ease-out;
            `;
            
            if (type === 'success') {
                messageDiv.style.background = 'linear-gradient(135deg, #00b894 0%, #00a085 100%)';
            } else {
                messageDiv.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
            }
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 300);
            }, 3000);
        }

        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Remplacer la section de chargement des donn√©es (lignes ~550-750) par ceci :

// Charger toutes les donn√©es suppl√©mentaires
async function loadAutresSources() {
    try {
        const response = await fetch(AUTRES_SOURCES_URL);
        if (response.ok) {
            const csvText = await response.text();
            const lines = parseCSV(csvText);
            
            // 1. Charger les d√©tails d√©penses (B2:G15)
            detailsDepensesData = [];
            for (let i = 1; i < 15; i++) { // Lignes 2 √† 15 (index 1 √† 14)
                if (i < lines.length) {
                    const row = lines[i];
                    if (row && row.length >= 7) {
                        const titre = row[1] ? row[1].trim() : ''; // Colonne B
                        const categoriesValides = [
                            'Admin', 'Artisanat', 'Cadeaux', 'Divers', 'Don',
                            'Nourritures', 'Logistique', 'Repetition', 'Tenue',
                            'Tp terrestre&frais', 'Tp aerien&frais', 'Vente', 'Visa'
                        ];
                        if (titre && categoriesValides.includes(titre)) {
                            detailsDepensesData.push({
                                'Depenses': titre,
                                'Ariary': parseFinancialValue(row[2] || '0'),  // Colonne C
                                'Euro': parseFinancialValue(row[3] || '0'),    // Colonne D
                                'Franc Suisse': parseFinancialValue(row[4] || '0'), // Colonne E
                                'Livre': parseFinancialValue(row[5] || '0'),  // Colonne F
                                'Banque Euro': parseFinancialValue(row[6] || '0') // Colonne G
                            });
                        }
                    }
                }
            }
            
            // 2. Charger les d√©tails don (I3:N4)
            for (let i = 2; i < 4; i++) { // Lignes 3 et 4 (index 2 et 3)
                if (i < lines.length) {
                    const row = lines[i];
                    if (row && row.length >= 14) {
                        const titre = i === 2 ? 'Don Membre' : 'Don Divers';
                        detailsDonData.push({
                            'Type': titre,
                            'Ariary': parseFinancialValue(row[8] || '0'),   // Colonne I
                            'Euro': parseFinancialValue(row[9] || '0'),     // Colonne J
                            'Franc Suisse': parseFinancialValue(row[10] || '0'), // Colonne K
                            'Livre': parseFinancialValue(row[11] || '0'),   // Colonne L
                            'Banque Euro': parseFinancialValue(row[12] || '0') // Colonne M
                        });
                    }
                }
            }
            
            // 3. Charger Emprunt
            if (lines.length > 18) {
                // Montant Emprunt (I18:N18) - colonnes I √† N
                const montantRow = lines[17]; // Ligne 18 (index 17)
                if (montantRow && montantRow.length >= 14) {
                    detailsEmpruntData.montant = {
                        'Ariary': parseFinancialValue(montantRow[8] || '0'),   // Colonne I
                        'Euro': parseFinancialValue(montantRow[9] || '0'),     // Colonne J
                        'Franc Suisse': parseFinancialValue(montantRow[10] || '0'), // Colonne K
                        'Livre': parseFinancialValue(montantRow[11] || '0'),   // Colonne L
                        'Banque Euro': parseFinancialValue(montantRow[12] || '0') // Colonne M
                    };
                }
                
                // Remboursement Emprunt (B8:G8) - colonnes B √† G
                const rembRow = lines[7]; // Ligne 8 (index 7)
                if (rembRow && rembRow.length >= 7) {
                    detailsEmpruntData.remboursement = {
                        'Ariary': parseFinancialValue(rembRow[1] || '0'),   // Colonne B
                        'Euro': parseFinancialValue(rembRow[2] || '0'),     // Colonne C
                        'Franc Suisse': parseFinancialValue(rembRow[3] || '0'), // Colonne D
                        'Livre': parseFinancialValue(rembRow[4] || '0'),    // Colonne E
                        'Banque Euro': parseFinancialValue(rembRow[5] || '0') // Colonne F
                    };
                }
            }
            
            // 4. Charger Pr√™t
            if (lines.length > 19) {
                // Montant Pr√™t donn√© (B19:G19) - colonnes B √† G
                const montantPretRow = lines[18]; // Ligne 19 (index 18)
                if (montantPretRow && montantPretRow.length >= 7) {
                    detailsPretData.montant = {
                        'Ariary': parseFinancialValue(montantPretRow[1] || '0'),   // Colonne B
                        'Euro': parseFinancialValue(montantPretRow[2] || '0'),     // Colonne C
                        'Franc Suisse': parseFinancialValue(montantPretRow[3] || '0'), // Colonne D
                        'Livre': parseFinancialValue(montantPretRow[4] || '0'),    // Colonne E
                        'Banque Euro': parseFinancialValue(montantPretRow[5] || '0') // Colonne F
                    };
                }
                
                // Remboursement Pr√™t (I19:N19) - colonnes I √† N
                const rembPretRow = lines[18]; // M√™me ligne, colonnes I √† N
                if (rembPretRow && rembPretRow.length >= 14) {
                    detailsPretData.remboursement = {
                        'Ariary': parseFinancialValue(rembPretRow[8] || '0'),   // Colonne I
                        'Euro': parseFinancialValue(rembPretRow[9] || '0'),     // Colonne J
                        'Franc Suisse': parseFinancialValue(rembPretRow[10] || '0'), // Colonne K
                        'Livre': parseFinancialValue(rembPretRow[11] || '0'),   // Colonne L
                        'Banque Euro': parseFinancialValue(rembPretRow[12] || '0') // Colonne M
                    };
                }
            }
            
            // 5. Charger Transfert (ligne 20)
            if (lines.length > 20) {
                // Montant Transfert (B20:G20) - colonnes B √† G
                const montantTransfertRow = lines[19]; // Ligne 20 (index 19)
                if (montantTransfertRow && montantTransfertRow.length >= 7) {
                    detailsTransfertData.montant = {
                        'Ariary': parseFinancialValue(montantTransfertRow[1] || '0'), // Colonne B
                        'Euro': parseFinancialValue(montantTransfertRow[2] || '0'),   // Colonne C
                        'Franc Suisse': parseFinancialValue(montantTransfertRow[3] || '0'), // Colonne D
                        'Livre': parseFinancialValue(montantTransfertRow[4] || '0'),  // Colonne E
                        'Banque Euro': parseFinancialValue(montantTransfertRow[5] || '0') // Colonne F
                    };
                }
                
                // Remboursement Transfert (I20:N20) - colonnes I √† N
                const rembTransfertRow = lines[19];
                if (rembTransfertRow && rembTransfertRow.length >= 14) {
                    detailsTransfertData.remboursement = {
                        'Ariary': parseFinancialValue(rembTransfertRow[8] || '0'),  // Colonne I
                        'Euro': parseFinancialValue(rembTransfertRow[9] || '0'),    // Colonne J
                        'Franc Suisse': parseFinancialValue(rembTransfertRow[10] || '0'), // Colonne K
                        'Livre': parseFinancialValue(rembTransfertRow[11] || '0'),  // Colonne L
                        'Banque Euro': parseFinancialValue(rembTransfertRow[12] || '0') // Colonne M
                    };
                }
            }
            
            // 6. Charger Change (ligne 21)
            if (lines.length > 21) {
                // Montant Change (B21:G21) - colonnes B √† G
                const montantChangeRow = lines[20]; // Ligne 21 (index 20)
                if (montantChangeRow && montantChangeRow.length >= 7) {
                    detailsChangeData.montant = {
                        'Ariary': parseFinancialValue(montantChangeRow[1] || '0'), // Colonne B
                        'Euro': parseFinancialValue(montantChangeRow[2] || '0'),   // Colonne C
                        'Franc Suisse': parseFinancialValue(montantChangeRow[3] || '0'), // Colonne D
                        'Livre': parseFinancialValue(montantChangeRow[4] || '0'),  // Colonne E
                        'Banque Euro': parseFinancialValue(montantChangeRow[5] || '0') // Colonne F
                    };
                }
                
                // Remboursement Change (I21:N21) - colonnes I √† N
                const rembChangeRow = lines[20];
                if (rembChangeRow && rembChangeRow.length >= 14) {
                    detailsChangeData.remboursement = {
                        'Ariary': parseFinancialValue(rembChangeRow[8] || '0'),  // Colonne I
                        'Euro': parseFinancialValue(rembChangeRow[9] || '0'),    // Colonne J
                        'Franc Suisse': parseFinancialValue(rembChangeRow[10] || '0'), // Colonne K
                        'Livre': parseFinancialValue(rembChangeRow[11] || '0'),  // Colonne L
                        'Banque Euro': parseFinancialValue(rembChangeRow[12] || '0') // Colonne M
                    };
                }
            }
            
            // 7. Charger les donn√©es Emprunt/Pr√™t/Transfert/Change (P4:U8) pour le tableau principal
            for (let i = 3; i < 8; i++) { // Lignes 4 √† 8 (index 3 √† 7)
                if (i < lines.length) {
                    const row = lines[i];
                    if (row && row.length >= 21) {
                        const titre = row[15] ? row[15].trim() : ''; // Colonne P
                        if (['Emprunt', 'Pret', 'Transfert', 'Change'].includes(titre)) {
                            autresSourcesData[titre] = {
                                'Ariary': parseFinancialValue(row[16] || '0'), // Colonne Q
                                'Euro': parseFinancialValue(row[17] || '0'),   // Colonne R
                                'Franc Suisse': parseFinancialValue(row[18] || '0'), // Colonne S
                                'Livre': parseFinancialValue(row[19] || '0'),  // Colonne T
                                'Banque Euro': parseFinancialValue(row[20] || '0') // Colonne U
                            };
                        }
                    }
                }
            }
            
            console.log('‚úÖ Donn√©es charg√©es avec les bons mappings de colonnes:', {
                depenses: detailsDepensesData.length,
                don: detailsDonData.length,
                emprunt: detailsEmpruntData,
                pret: detailsPretData,
                transfert: detailsTransfertData,
                change: detailsChangeData
            });
            
            // Afficher les mappings pour v√©rification
            console.log('Mapping Emprunt - Montant (I:N):', detailsEmpruntData.montant);
            console.log('Mapping Emprunt - Remboursement (B:G):', detailsEmpruntData.remboursement);
            console.log('Mapping Pr√™t - Montant donn√© (B:G):', detailsPretData.montant);
            console.log('Mapping Pr√™t - Remboursement (I:N):', detailsPretData.remboursement);
        }
    } catch (error) {
        console.error('‚ùå Erreur chargement donn√©es:', error);
    }
}

        // Fonction pour afficher une bulle g√©n√©rique (Emprunt, Pret, Transfert, Change)
        function showDetailsBulle(event, title, data) {
            const bulle = document.getElementById('detailsBulle');
            const overlay = document.getElementById('detailsOverlay');
            const content = document.getElementById('detailsBulleContent');
            const titleElement = document.getElementById('bulleTitle');
            
            if (title === 'Pret') {
                titleElement.textContent = 'üìã D√âTAILS PRET (REMBOURSEMENT)';
            } else {
                titleElement.textContent = `üìã D√âTAILS ${title.toUpperCase()}`;
            }
            
            let html = '<table>';
            
            if (title === 'Pret') {
                html += '<tr><th>Op√©ration</th><th>Ariary</th><th>Euro</th><th>Franc Suisse</th><th>Livre</th><th>Banque Euro</th></tr>';
                
                // Ligne pret donn√© (montant)
                html += '<tr>';
                html += `<td>Pr√™t donn√©</td>`;
                html += `<td>${formatNumberWithUnit(data.montant?.Ariary || 0, 'Ariary')}</td>`;
                html += `<td>${formatNumberWithUnit(data.montant?.Euro || 0, 'Euro')}</td>`;
                html += `<td>${formatNumberWithUnit(data.montant?.['Franc Suisse'] || 0, 'Franc Suisse')}</td>`;
                html += `<td>${formatNumberWithUnit(data.montant?.Livre || 0, 'Livre')}</td>`;
                html += `<td>${formatNumberWithUnit(data.montant?.['Banque Euro'] || 0, 'Banque Euro')}</td>`;
                html += '</tr>';
                
                // Ligne remboursement pret
                html += '<tr>';
                html += `<td>Remboursement pr√™t</td>`;
                html += `<td>${formatNumberWithUnit(data.remboursement?.Ariary || 0, 'Ariary')}</td>`;
                html += `<td>${formatNumberWithUnit(data.remboursement?.Euro || 0, 'Euro')}</td>`;
                html += `<td>${formatNumberWithUnit(data.remboursement?.['Franc Suisse'] || 0, 'Franc Suisse')}</td>`;
                html += `<td>${formatNumberWithUnit(data.remboursement?.Livre || 0, 'Livre')}</td>`;
                html += `<td>${formatNumberWithUnit(data.remboursement?.['Banque Euro'] || 0, 'Banque Euro')}</td>`;
                html += '</tr>';
                
                // Ligne solde (pret donn√© - remboursement)
                const solde = {
                    'Ariary': (data.montant?.Ariary || 0) - (data.remboursement?.Ariary || 0),
                    'Euro': (data.montant?.Euro || 0) - (data.remboursement?.Euro || 0),
                    'Franc Suisse': (data.montant?.['Franc Suisse'] || 0) - (data.remboursement?.['Franc Suisse'] || 0),
                    'Livre': (data.montant?.Livre || 0) - (data.remboursement?.Livre || 0),
                    'Banque Euro': (data.montant?.['Banque Euro'] || 0) - (data.remboursement?.['Banque Euro'] || 0)
                };
                
                html += '<tr class="total-row">';
                html += '<td>SOLDE (Pr√™t donn√© - Remboursement)</td>';
                html += `<td>${formatNumberWithUnit(solde['Ariary'], 'Ariary')}</td>`;
                html += `<td>${formatNumberWithUnit(solde['Euro'], 'Euro')}</td>`;
                html += `<td>${formatNumberWithUnit(solde['Franc Suisse'], 'Franc Suisse')}</td>`;
                html += `<td>${formatNumberWithUnit(solde['Livre'], 'Livre')}</td>`;
                html += `<td>${formatNumberWithUnit(solde['Banque Euro'], 'Banque Euro')}</td>`;
                html += '</tr>';
            } else {
                html += '<tr><th>Op√©ration</th><th>Ariary</th><th>Euro</th><th>Franc Suisse</th><th>Livre</th><th>Banque Euro</th></tr>';
                
                // Ligne montant/emprunt
                html += '<tr>';
                html += `<td>${title} re√ßu</td>`;
                html += `<td>${formatNumberWithUnit(data.montant?.Ariary || 0, 'Ariary')}</td>`;
                html += `<td>${formatNumberWithUnit(data.montant?.Euro || 0, 'Euro')}</td>`;
                html += `<td>${formatNumberWithUnit(data.montant?.['Franc Suisse'] || 0, 'Franc Suisse')}</td>`;
                html += `<td>${formatNumberWithUnit(data.montant?.Livre || 0, 'Livre')}</td>`;
                html += `<td>${formatNumberWithUnit(data.montant?.['Banque Euro'] || 0, 'Banque Euro')}</td>`;
                html += '</tr>';
                
                // Ligne remboursement
                html += '<tr>';
                html += `<td>Remboursement ${title}</td>`;
                html += `<td>${formatNumberWithUnit(data.remboursement?.Ariary || 0, 'Ariary')}</td>`;
                html += `<td>${formatNumberWithUnit(data.remboursement?.Euro || 0, 'Euro')}</td>`;
                html += `<td>${formatNumberWithUnit(data.remboursement?.['Franc Suisse'] || 0, 'Franc Suisse')}</td>`;
                html += `<td>${formatNumberWithUnit(data.remboursement?.Livre || 0, 'Livre')}</td>`;
                html += `<td>${formatNumberWithUnit(data.remboursement?.['Banque Euro'] || 0, 'Banque Euro')}</td>`;
                html += '</tr>';
                
                // Ligne solde
                const solde = {
                    'Ariary': (data.montant?.Ariary || 0) - (data.remboursement?.Ariary || 0),
                    'Euro': (data.montant?.Euro || 0) - (data.remboursement?.Euro || 0),
                    'Franc Suisse': (data.montant?.['Franc Suisse'] || 0) - (data.remboursement?.['Franc Suisse'] || 0),
                    'Livre': (data.montant?.Livre || 0) - (data.remboursement?.Livre || 0),
                    'Banque Euro': (data.montant?.['Banque Euro'] || 0) - (data.remboursement?.['Banque Euro'] || 0)
                };
                
                html += '<tr class="total-row">';
                html += '<td>SOLDE</td>';
                html += `<td>${formatNumberWithUnit(solde['Ariary'], 'Ariary')}</td>`;
                html += `<td>${formatNumberWithUnit(solde['Euro'], 'Euro')}</td>`;
                html += `<td>${formatNumberWithUnit(solde['Franc Suisse'], 'Franc Suisse')}</td>`;
                html += `<td>${formatNumberWithUnit(solde['Livre'], 'Livre')}</td>`;
                html += `<td>${formatNumberWithUnit(solde['Banque Euro'], 'Banque Euro')}</td>`;
                html += '</tr>';
            }
            
            html += '</table>';
            content.innerHTML = html;
            
            // Positionner la bulle en haut de l'√©cran
            bulle.style.display = 'block';
            overlay.style.display = 'block';
            
            // Centrer horizontalement et placer en haut
            const bulleWidth = bulle.offsetWidth;
            const windowWidth = window.innerWidth;
            let left = (windowWidth - bulleWidth) / 2;
            if (left < 20) left = 20;
            
            bulle.style.left = left + 'px';
            bulle.style.top = '20px';
        }

        // Fonction pour afficher la bulle des d√©penses
        function showDetailsDepenses(event) {
            const bulle = document.getElementById('detailsBulle');
            const overlay = document.getElementById('detailsOverlay');
            const content = document.getElementById('detailsBulleContent');
            const titleElement = document.getElementById('bulleTitle');
            
            titleElement.textContent = 'üìã D√âTAILS D√âPENSES';
            
            if (detailsDepensesData.length === 0) {
                content.innerHTML = '<p style="text-align:center;color:#e74c3c;">Aucune donn√©e disponible</p>';
            } else {
                let html = '<table>';
                html += '<tr><th>D√©penses</th><th>Ariary</th><th>Euro</th><th>Franc Suisse</th><th>Livre</th><th>Banque Euro</th></tr>';
                
                let totaux = {
                    'Ariary': 0, 'Euro': 0, 'Franc Suisse': 0, 'Livre': 0, 'Banque Euro': 0
                };
                
                detailsDepensesData.forEach(item => {
                    html += '<tr>';
                    html += `<td>${item['Depenses']}</td>`;
                    html += `<td>${formatNumberWithUnit(item['Ariary'], 'Ariary')}</td>`;
                    html += `<td>${formatNumberWithUnit(item['Euro'], 'Euro')}</td>`;
                    html += `<td>${formatNumberWithUnit(item['Franc Suisse'], 'Franc Suisse')}</td>`;
                    html += `<td>${formatNumberWithUnit(item['Livre'], 'Livre')}</td>`;
                    html += `<td>${formatNumberWithUnit(item['Banque Euro'], 'Banque Euro')}</td>`;
                    html += '</tr>';
                    
                    totaux['Ariary'] += item['Ariary'];
                    totaux['Euro'] += item['Euro'];
                    totaux['Franc Suisse'] += item['Franc Suisse'];
                    totaux['Livre'] += item['Livre'];
                    totaux['Banque Euro'] += item['Banque Euro'];
                });
                
                html += '<tr class="total-row">';
                html += '<td>TOTAL D√âPENSES</td>';
                html += `<td>${formatNumberWithUnit(totaux['Ariary'], 'Ariary')}</td>`;
                html += `<td>${formatNumberWithUnit(totaux['Euro'], 'Euro')}</td>`;
                html += `<td>${formatNumberWithUnit(totaux['Franc Suisse'], 'Franc Suisse')}</td>`;
                html += `<td>${formatNumberWithUnit(totaux['Livre'], 'Livre')}</td>`;
                html += `<td>${formatNumberWithUnit(totaux['Banque Euro'], 'Banque Euro')}</td>`;
                html += '</tr>';
                
                html += '</table>';
                content.innerHTML = html;
            }
            
            // Positionner la bulle en haut de l'√©cran
            bulle.style.display = 'block';
            overlay.style.display = 'block';
            
            // Centrer horizontalement et placer en haut
            const bulleWidth = bulle.offsetWidth;
            const windowWidth = window.innerWidth;
            let left = (windowWidth - bulleWidth) / 2;
            if (left < 20) left = 20;
            
            bulle.style.left = left + 'px';
            bulle.style.top = '20px';
        }

        // Fonction pour afficher la bulle des dons
        function showDetailsDon(event) {
            const bulle = document.getElementById('detailsBulle');
            const overlay = document.getElementById('detailsOverlay');
            const content = document.getElementById('detailsBulleContent');
            const titleElement = document.getElementById('bulleTitle');
            
            titleElement.textContent = 'üìã D√âTAILS DONS';
            
            if (detailsDonData.length === 0) {
                content.innerHTML = '<p style="text-align:center;color:#e74c3c;">Aucune donn√©e disponible</p>';
            } else {
                let html = '<table>';
                html += '<tr><th>Type de don</th><th>Ariary</th><th>Euro</th><th>Franc Suisse</th><th>Livre</th><th>Banque Euro</th></tr>';
                
                let totaux = {
                    'Ariary': 0, 'Euro': 0, 'Franc Suisse': 0, 'Livre': 0, 'Banque Euro': 0
                };
                
                detailsDonData.forEach(item => {
                    html += '<tr>';
                    html += `<td>${item['Type']}</td>`;
                    html += `<td>${formatNumberWithUnit(item['Ariary'], 'Ariary')}</td>`;
                    html += `<td>${formatNumberWithUnit(item['Euro'], 'Euro')}</td>`;
                    html += `<td>${formatNumberWithUnit(item['Franc Suisse'], 'Franc Suisse')}</td>`;
                    html += `<td>${formatNumberWithUnit(item['Livre'], 'Livre')}</td>`;
                    html += `<td>${formatNumberWithUnit(item['Banque Euro'], 'Banque Euro')}</td>`;
                    html += '</tr>';
                    
                    totaux['Ariary'] += item['Ariary'];
                    totaux['Euro'] += item['Euro'];
                    totaux['Franc Suisse'] += item['Franc Suisse'];
                    totaux['Livre'] += item['Livre'];
                    totaux['Banque Euro'] += item['Banque Euro'];
                });
                
                html += '<tr class="total-row">';
                html += '<td>TOTAL DONS</td>';
                html += `<td>${formatNumberWithUnit(totaux['Ariary'], 'Ariary')}</td>`;
                html += `<td>${formatNumberWithUnit(totaux['Euro'], 'Euro')}</td>`;
                html += `<td>${formatNumberWithUnit(totaux['Franc Suisse'], 'Franc Suisse')}</td>`;
                html += `<td>${formatNumberWithUnit(totaux['Livre'], 'Livre')}</td>`;
                html += `<td>${formatNumberWithUnit(totaux['Banque Euro'], 'Banque Euro')}</td>`;
                html += '</tr>';
                
                html += '</table>';
                content.innerHTML = html;
            }
            
            // Positionner la bulle en haut de l'√©cran
            bulle.style.display = 'block';
            overlay.style.display = 'block';
            
            // Centrer horizontalement et placer en haut
            const bulleWidth = bulle.offsetWidth;
            const windowWidth = window.innerWidth;
            let left = (windowWidth - bulleWidth) / 2;
            if (left < 20) left = 20;
            
            bulle.style.left = left + 'px';
            bulle.style.top = '20px';
        }
        
        function hideDetailsBulle() {
            document.getElementById('detailsBulle').style.display = 'none';
            document.getElementById('detailsOverlay').style.display = 'none';
        }

        function processCSVData(csvText) {
            try {
                if (!csvText || csvText.trim().length === 0) {
                    throw new Error('Le fichier CSV est vide');
                }
                
                const lines = parseCSV(csvText);
                
                if (!lines || lines.length < 5) {
                    throw new Error('Format de donn√©es invalide');
                }
                
                headers = lines[3] || [];
                sheetData = lines.slice(4).filter(row => 
                    row && row.some(cell => cell && cell.trim() !== '')
                );
                
                console.log(`üìä ${sheetData.length} lignes de donn√©es charg√©es`);
                
                // Charger les donn√©es suppl√©mentaires
                loadAutresSources().then(() => {
                    extractDatesWithData();
                    renderCalendar();
                    displayGlobalStats();
                    checkExistingAuthentication();
                });
                
            } catch (error) {
                console.error('‚ùå Erreur de traitement:', error);
                showError(`Erreur de traitement des donn√©es: ${error.message}`);
                showRetryOptions();
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        async function loadDataFromGoogleSheets(method = 'direct') {
            console.log(`üîç Tentative de chargement avec m√©thode: ${method}`);
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('retryOptions').style.display = 'none';
            clearErrorMessages();
            
            try {
                let response;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                switch(method) {
                    case 'direct':
                        response = await fetch(GOOGLE_SHEETS_URL, {
                            signal: controller.signal,
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        break;
                        
                    case 'proxy':
                        const proxyUrl = `https://cors-anywhere.herokuapp.com/${GOOGLE_SHEETS_URL}`;
                        response = await fetch(proxyUrl, {
                            signal: controller.signal,
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });
                        break;
                        
                    case 'cors':
                        const corsProxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(GOOGLE_SHEETS_URL)}`;
                        response = await fetch(corsProxy, {
                            signal: controller.signal
                        });
                        break;
                }
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    const csvText = await response.text();
                    console.log('‚úÖ Donn√©es charg√©es avec succ√®s');
                    processCSVData(csvText);
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
            } catch (error) {
                console.log(`‚ùå √âchec avec ${method}:`, error.message);
                
                if (method === 'direct') {
                    console.log('üîÑ Essai automatique avec m√©thode proxy...');
                    loadDataFromGoogleSheets('proxy');
                } else if (method === 'proxy') {
                    console.log('üîÑ Essai automatique avec m√©thode CORS...');
                    loadDataFromGoogleSheets('cors');
                } else {
                    showRetryOptions();
                    showError(`Impossible de charger les donn√©es. V√©rifiez:<br>
                    1. Votre connexion internet<br>
                    2. Que le Google Sheet est bien publi√©<br>
                    3. Essayez une m√©thode alternative ci-dessous`);
                }
            }
        }

        function showRetryOptions() {
            document.getElementById('retryOptions').style.display = 'block';
        }

        function parseCSV(csvText) {
            const lines = [];
            let currentLine = [];
            let currentField = '';
            let inQuotes = false;
            
            for (let i = 0; i < csvText.length; i++) {
                const char = csvText[i];
                const nextChar = csvText[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    currentLine.push(currentField);
                    currentField = '';
                } else if (char === '\n' && !inQuotes) {
                    currentLine.push(currentField);
                    lines.push(currentLine);
                    currentLine = [];
                    currentField = '';
                } else if (char === '\r') {
                    continue;
                } else {
                    currentField += char;
                }
            }
            
            if (currentField !== '' || currentLine.length > 0) {
                currentLine.push(currentField);
                lines.push(currentLine);
            }
            
            return lines;
        }
        
        function extractDatesWithData() {
            datesWithData = [];
            
            sheetData.forEach((row, index) => {
                const dateStr = row[0] || '';
                if (dateStr && dateStr.trim() !== '') {
                    const date = parseDate(dateStr);
                    if (date) {
                        datesWithData.push({
                            date: date,
                            dateStr: dateStr,
                            localite: row[1] || '',
                            pays: row[2] || '',
                            rowIndex: index
                        });
                    }
                }
            });
            
            datesWithData.sort((a, b) => a.date - b.date);
            console.log(`üìÖ ${datesWithData.length} dates avec donn√©es trouv√©es`);
        }
        
        function parseDate(dateStr) {
            const formats = [
                'DD/MM/YYYY',
                'DD-MM-YYYY', 
                'YYYY-MM-DD',
                'MM/DD/YYYY'
            ];
            
            for (const format of formats) {
                const date = parseDateWithFormat(dateStr, format);
                if (date && !isNaN(date.getTime())) {
                    return date;
                }
            }
            
            const nativeDate = new Date(dateStr);
            if (!isNaN(nativeDate.getTime())) {
                return nativeDate;
            }
            
            console.warn(`Impossible de parser la date: ${dateStr}`);
            return null;
        }
        
        function parseDateWithFormat(dateStr, format) {
            const parts = dateStr.split(/[/\-.]/);
            const formatParts = format.split(/[/\-.]/);
            
            if (parts.length !== 3) return null;
            
            let day, month, year;
            
            for (let i = 0; i < 3; i++) {
                if (formatParts[i] === 'DD') day = parseInt(parts[i], 10);
                else if (formatParts[i] === 'MM') month = parseInt(parts[i], 10) - 1;
                else if (formatParts[i] === 'YYYY') year = parseInt(parts[i], 10);
            }
            
            if (day && month !== undefined && year) {
                return new Date(year, month, day);
            }
            
            return null;
        }
        
        function formatDateForDisplay(date) {
            if (!date) return 'Date inconnue';
            const days = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];
            const months = ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'];
            
            const dayName = days[date.getDay()];
            const day = date.getDate().toString().padStart(2, '0');
            const month = months[date.getMonth()];
            const year = date.getFullYear().toString().slice(-2);
            
            return `${dayName} ${day}-${month}-${year}`;
        }
        
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            
            currentMonthElement.textContent = currentDate.toLocaleDateString('fr-FR', {
                month: 'long',
                year: 'numeric'
            });
            
            calendarGrid.innerHTML = '';
            
            const daysOfWeek = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            daysOfWeek.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });
            
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            
            let firstDayOfWeek = firstDayOfMonth.getDay();
            firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
            
            const prevMonthLastDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0).getDate();
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = prevMonthLastDay - i;
                calendarGrid.appendChild(day);
            }
            
            for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day';
                day.innerHTML = `<div>${i}</div>`;
                
                const dateToCheck = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                const dateData = datesWithData.find(item => 
                    item.date.getDate() === dateToCheck.getDate() &&
                    item.date.getMonth() === dateToCheck.getMonth() &&
                    item.date.getFullYear() === dateToCheck.getFullYear()
                );
                
                if (dateData) {
                    day.classList.add('has-data');
                    const dateInfo = document.createElement('div');
                    dateInfo.className = 'date-info';
                    if (dateData.localite) {
                        dateInfo.innerHTML += `<div class="localite">${dateData.localite}</div>`;
                    }
                    if (dateData.pays) {
                        dateInfo.innerHTML += `<div class="pays">${dateData.pays}</div>`;
                    }
                    day.appendChild(dateInfo);
                }
                
                if (selectedDate && 
                    selectedDate.getDate() === i &&
                    selectedDate.getMonth() === currentDate.getMonth() &&
                    selectedDate.getFullYear() === currentDate.getFullYear()) {
                    day.classList.add('selected');
                }
                
                day.addEventListener('click', () => {
                    selectDate(new Date(currentDate.getFullYear(), currentDate.getMonth(), i));
                });
                
                calendarGrid.appendChild(day);
            }
            
            const totalCells = 42;
            const daysInCalendar = firstDayOfWeek + lastDayOfMonth.getDate();
            const nextMonthDays = totalCells - daysInCalendar;
            
            for (let i = 1; i <= nextMonthDays; i++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = i;
                calendarGrid.appendChild(day);
            }
        }
        
        function selectDate(date) {
            selectedDate = date;
            renderCalendar();
            
            const matchingRows = findDataByDate(date);
            displayResults(matchingRows, `Donn√©es financi√®res du ${formatDateForDisplay(date)}`);
        }
        
        function findDataByDate(date) {
            return sheetData.filter((row, index) => {
                const rowDateStr = row[0] || '';
                const rowDate = parseDate(rowDateStr);
                
                if (rowDate) {
                    return rowDate.getDate() === date.getDate() &&
                           rowDate.getMonth() === date.getMonth() &&
                           rowDate.getFullYear() === date.getFullYear();
                }
                
                return false;
            });
        }
        
        function prevMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        function handleSearch(event) {
            if (event) event.preventDefault();
            
            const searchValue = document.getElementById('searchText').value.trim();
            currentSearchTerm = searchValue;
            
            if (!searchValue) {
                alert('Veuillez entrer un mot ou une phrase pour la recherche');
                return;
            }
            
            if (sheetData.length === 0) {
                alert('Aucune donn√©e charg√©e');
                return;
            }
            
            const results = searchData(searchValue);
            displayResults(results, searchValue);
        }
        
        function showAllData() {
            if (sheetData.length === 0) {
                alert('Aucune donn√©e charg√©e');
                return;
            }
            
            currentSearchTerm = '';
            displayResults(sheetData, 'Toutes les donn√©es financi√®res');
        }
        
        function searchData(searchValue) {
            const searchLower = searchValue.toLowerCase();
            
            return sheetData.filter(row => {
                return row.some(cell => {
                    const cellValue = String(cell).toLowerCase();
                    return cellValue.includes(searchLower);
                });
            });
        }

        function cleanNumber(value) {
            if (!value || value === '') return '0';
            return String(value).replace(/[^\d,.-]/g, '').replace(',', '.');
        }

        function parseFinancialValue(value) {
            const cleaned = cleanNumber(value);
            const num = parseFloat(cleaned);
            return isNaN(num) ? 0 : num;
        }

        function formatNumberWithUnit(value, currency) {
            if (value === 0) return '0';
            const units = {
                'Ariary': 'Ar',
                'Euro': '‚Ç¨',
                'Franc Suisse': 'CHF',
                'Livre': '¬£',
                'Banque Euro': '‚Ç¨'
            };
            return `${new Intl.NumberFormat('fr-FR').format(value)} ${units[currency]}`;
        }

        function displayGlobalStats() {
            const statsSection = document.getElementById('globalStats');
            
            if (sheetData.length === 0) {
                statsSection.innerHTML = '<p>Aucune donn√©e disponible</p>';
                return;
            }

            const columnMapping = {
                'Ariary': {
                    'Ventes': 3,
                    'Collecte': 4,
                    'Don': 5,
                    'Depenses': 6
                },
                'Euro': {
                    'Ventes': 7,
                    'Collecte': 8,
                    'Don': 9,
                    'Depenses': 10
                },
                'Franc Suisse': {
                    'Ventes': 11,
                    'Collecte': 12,
                    'Don': 13,
                    'Depenses': 14
                },
                'Livre': {
                    'Ventes': 15,
                    'Collecte': 16,
                    'Don': 17,
                    'Depenses': 18
                },
                'Banque Euro': {
                    'Ventes': 19,
                    'Collecte': 20,
                    'Don': 21,
                    'Depenses': 22
                }
            };

            const globalTotals = {};
            Object.keys(columnMapping).forEach(currency => {
                globalTotals[currency] = {
                    'Ventes': 0,
                    'Collecte': 0,
                    'Don': 0,
                    'Depenses': 0
                };
            });

            sheetData.forEach(row => {
                Object.keys(columnMapping).forEach(currency => {
                    const cols = columnMapping[currency];
                    globalTotals[currency]['Ventes'] += parseFinancialValue(row[cols['Ventes']] || '0');
                    globalTotals[currency]['Collecte'] += parseFinancialValue(row[cols['Collecte']] || '0');
                    globalTotals[currency]['Don'] += parseFinancialValue(row[cols['Don']] || '0');
                    globalTotals[currency]['Depenses'] += parseFinancialValue(row[cols['Depenses']] || '0');
                });
            });

            const fondsPropres = {};
            Object.keys(columnMapping).forEach(currency => {
                const recettes = globalTotals[currency]['Ventes'] + globalTotals[currency]['Collecte'] + globalTotals[currency]['Don'];
                const depenses = globalTotals[currency]['Depenses'];
                fondsPropres[currency] = recettes - depenses;
            });

            let html = '<table class="financial-table">';
            
            html += '<tr><th class="category">Cat√©gorie</th>';
            Object.keys(columnMapping).forEach(currency => {
                html += `<th>${currency}</th>`;
            });
            html += '</tr>';
            
            const categories = ['Ventes', 'Collecte', 'Don', 'Depenses'];
            categories.forEach(category => {
                if (category === 'Depenses') {
                    html += `<tr class="depenses-row" onclick="showDetailsDepenses(event)"><td class="category">${category}</td>`;
                } else if (category === 'Don') {
                    html += `<tr class="don-row" onclick="showDetailsDon(event)"><td class="category">${category}</td>`;
                } else {
                    html += `<tr><td class="category">${category}</td>`;
                }
                Object.keys(columnMapping).forEach(currency => {
                    const value = globalTotals[currency][category];
                    html += `<td>${formatNumberWithUnit(value, currency)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '<tr class="recettes-row"><td class="category">RECETTES TOTALES</td>';
            Object.keys(columnMapping).forEach(currency => {
                const recettes = globalTotals[currency]['Ventes'] + globalTotals[currency]['Collecte'] + globalTotals[currency]['Don'];
                html += `<td>${formatNumberWithUnit(recettes, currency)}</td>`;
            });
            html += '</tr>';
            
            html += '<tr class="depenses-row"><td class="category">DEPENSES TOTALES</td>';
            Object.keys(columnMapping).forEach(currency => {
                const depenses = globalTotals[currency]['Depenses'];
                html += `<td>${formatNumberWithUnit(depenses, currency)}</td>`;
            });
            html += '</tr>';
            
            html += '<tr class="fonds-propre-row"><td class="category">FONDS PROPRES</td>';
            Object.keys(columnMapping).forEach(currency => {
                html += `<td>${formatNumberWithUnit(fondsPropres[currency], currency)}</td>`;
            });
            html += '</tr>';
            
            if (Object.keys(autresSourcesData).length > 0) {
                html += '<tr class="autres-header"><td colspan="6" style="text-align:center;">AUTRES RESSOURCES ET DEPENSES</td></tr>';
                
                const sources = ['Emprunt', 'Pret', 'Transfert', 'Change'];
                sources.forEach(source => {
                    if (autresSourcesData[source]) {
                        let bgClass = '';
                        let clickHandler = '';
                        if (source === 'Emprunt') {
                            bgClass = 'emprunt-row';
                            clickHandler = `onclick="showDetailsBulle(event, 'Emprunt', detailsEmpruntData)"`;
                        } else if (source === 'Pret') {
                            bgClass = 'pret-row';
                            clickHandler = `onclick="showDetailsBulle(event, 'Pret', detailsPretData)"`;
                        } else if (source === 'Transfert') {
                            bgClass = 'transfert-row';
                            clickHandler = `onclick="showDetailsBulle(event, 'Transfert', detailsTransfertData)"`;
                        } else if (source === 'Change') {
                            bgClass = 'change-row';
                            clickHandler = `onclick="showDetailsBulle(event, 'Change', detailsChangeData)"`;
                        }
                        
                        html += `<tr class="${bgClass}" ${clickHandler}><td class="category">${source}</td>`;
                        Object.keys(columnMapping).forEach(currency => {
                            const value = autresSourcesData[source][currency] || 0;
                            html += `<td>${formatNumberWithUnit(value, currency)}</td>`;
                        });
                        html += '</tr>';
                    }
                });
                
                html += '<tr class="en-main-row"><td class="category">EN MAIN</td>';
                Object.keys(columnMapping).forEach(currency => {
                    const emprunt = autresSourcesData['Emprunt'] ? autresSourcesData['Emprunt'][currency] || 0 : 0;
                    const pret = autresSourcesData['Pret'] ? autresSourcesData['Pret'][currency] || 0 : 0;
                    const transfert = autresSourcesData['Transfert'] ? autresSourcesData['Transfert'][currency] || 0 : 0;
                    const change = autresSourcesData['Change'] ? autresSourcesData['Change'][currency] || 0 : 0;
                    
                    const enMain = fondsPropres[currency] + emprunt - pret - transfert - change;
                    html += `<td>${formatNumberWithUnit(enMain, currency)}</td>`;
                });
                html += '</tr>';
            }
            
            html += '</table>';
            
            statsSection.innerHTML = html;
        }
        
        function formatFinancialData(row) {
            const columnMapping = {
                'Ariary': {
                    'Ventes': 3,
                    'Collecte': 4,
                    'Don': 5,
                    'Depenses': 6
                },
                'Euro': {
                    'Ventes': 7,
                    'Collecte': 8,
                    'Don': 9,
                    'Depenses': 10
                },
                'Franc Suisse': {
                    'Ventes': 11,
                    'Collecte': 12,
                    'Don': 13,
                    'Depenses': 14
                },
                'Livre': {
                    'Ventes': 15,
                    'Collecte': 16,
                    'Don': 17,
                    'Depenses': 18
                },
                'Banque Euro': {
                    'Ventes': 19,
                    'Collecte': 20,
                    'Don': 21,
                    'Depenses': 22
                }
            };

            const totals = {};
            Object.keys(columnMapping).forEach(currency => {
                const cols = columnMapping[currency];
                const ventes = parseFinancialValue(row[cols['Ventes']] || '0');
                const collecte = parseFinancialValue(row[cols['Collecte']] || '0');
                const don = parseFinancialValue(row[cols['Don']] || '0');
                const depenses = parseFinancialValue(row[cols['Depenses']] || '0');
                totals[currency] = {
                    'Ventes': ventes,
                    'Collecte': collecte,
                    'Don': don,
                    'Depenses': depenses,
                    'Recettes': ventes + collecte + don,
                    'FondsPropres': ventes + collecte + don - depenses
                };
            });

            let html = '<div class="scroll-hint">Faites d√©filer horizontalement pour voir toutes les colonnes</div>';
            html += '<div class="financial-table-container">';
            html += '<table class="financial-table">';
            
            html += '<tr><th class="category">Cat√©gorie</th>';
            Object.keys(columnMapping).forEach(currency => {
                html += `<th>${currency}</th>`;
            });
            html += '</tr>';
            
            const categories = ['Ventes', 'Collecte', 'Don', 'Depenses'];
            categories.forEach(category => {
                // Pas d'√©v√©nements cliquables dans les r√©sultats de recherche
                html += `<tr><td class="category">${category}</td>`;
                Object.keys(columnMapping).forEach(currency => {
                    const value = totals[currency][category];
                    html += `<td>${formatNumberWithUnit(value, currency)}</td>`;
                });
                html += '</tr>';
            });
            
            html += '<tr class="recettes-row"><td class="category">RECETTES TOTALES</td>';
            Object.keys(columnMapping).forEach(currency => {
                html += `<td>${formatNumberWithUnit(totals[currency]['Recettes'], currency)}</td>`;
            });
            html += '</tr>';
            
            html += '<tr class="depenses-row"><td class="category">DEPENSES TOTALES</td>';
            Object.keys(columnMapping).forEach(currency => {
                html += `<td>${formatNumberWithUnit(totals[currency]['Depenses'], currency)}</td>`;
            });
            html += '</tr>';
            
            html += '<tr class="fonds-propre-row"><td class="category">FONDS PROPRES</td>';
            Object.keys(columnMapping).forEach(currency => {
                html += `<td>${formatNumberWithUnit(totals[currency]['FondsPropres'], currency)}</td>`;
            });
            html += '</tr>';
            
            if (Object.keys(autresSourcesData).length > 0) {
                html += '<tr class="autres-header"><td colspan="6" style="text-align:center;">AUTRES RESSOURCES ET DEPENSES</td></tr>';
                
                const sources = ['Emprunt', 'Pret', 'Transfert', 'Change'];
                sources.forEach(source => {
                    if (autresSourcesData[source]) {
                        // Pas d'√©v√©nements cliquables dans les r√©sultats de recherche
                        html += `<tr><td class="category">${source}</td>`;
                        Object.keys(columnMapping).forEach(currency => {
                            const value = autresSourcesData[source][currency] || 0;
                            html += `<td>${formatNumberWithUnit(value, currency)}</td>`;
                        });
                        html += '</tr>';
                    }
                });
                
                html += '<tr class="en-main-row"><td class="category">EN MAIN</td>';
                Object.keys(columnMapping).forEach(currency => {
                    const emprunt = autresSourcesData['Emprunt'] ? autresSourcesData['Emprunt'][currency] || 0 : 0;
                    const pret = autresSourcesData['Pret'] ? autresSourcesData['Pret'][currency] || 0 : 0;
                    const transfert = autresSourcesData['Transfert'] ? autresSourcesData['Transfert'][currency] || 0 : 0;
                    const change = autresSourcesData['Change'] ? autresSourcesData['Change'][currency] || 0 : 0;
                    
                    const enMain = totals[currency]['FondsPropres'] + emprunt - pret - transfert - change;
                    html += `<td>${formatNumberWithUnit(enMain, currency)}</td>`;
                });
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            return html;
        }
        
        function displayResults(results, searchTerm) {
            const resultsSection = document.getElementById('resultsSection');
            const resultContent = document.getElementById('resultContent');
            const resultTitle = document.getElementById('resultTitle');
            
            if (results.length === 0) {
                resultContent.innerHTML = `
                    <div class="no-results">
                        <h3>‚ùå Aucune donn√©e trouv√©e</h3>
                        <p>Aucune donn√©e financi√®re ne correspond √† votre recherche "${searchTerm}"</p>
                    </div>
                `;
            } else {
                let html = `
                    <div class="search-stats">
                        <strong>${results.length} ligne(s) de donn√©es trouv√©e(s)</strong> pour : "${searchTerm}"
                    </div>
                `;
                
                results.forEach((row, index) => {
                    const dateStr = row[0] || 'Date non sp√©cifi√©e';
                    const localite = row[1] || '';
                    const pays = row[2] || '';
                    
                    html += `
                        <div class="pv-item">
                            <div class="pv-header">
                                <h2>üí∞ Donn√©es Financi√®res</h2>
                                <h3 class="pv-title">
                                    ${formatDateForDisplay(parseDate(dateStr))}
                                </h3>
                            </div>
                            <div style="padding: 20px;">
                    `;
                    
                    if (localite || pays) {
                        html += `
                            <div class="location-info">
                                <strong>üìç Localisation :</strong> 
                                ${localite ? `<span class="localite">${localite}</span>` : ''}
                                ${pays ? ` - <span class="pays">${pays}</span>` : ''}
                            </div>
                        `;
                    }
                    
                    html += formatFinancialData(row);
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                resultContent.innerHTML = html;
            }
            
            resultTitle.textContent = `R√©sultats pour "${searchTerm}"`;
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeResults() {
            document.getElementById('resultsSection').style.display = 'none';
            currentSearchTerm = '';
        }

        function showError(message) {
            const searchSection = document.querySelector('.search-section');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = message;
            searchSection.appendChild(errorDiv);
        }

        function clearErrorMessages() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());
        }
        
        function showCountrySummary(pays) {
            console.log(`Affichage du r√©capitulatif pour ${pays}`);
            
            const countryData = sheetData.filter(row => {
                const rowPays = row[2] || '';
                return rowPays.toUpperCase() === pays.toUpperCase();
            });
            
            if (countryData.length === 0) {
                alert(`Aucune donn√©e trouv√©e pour ${pays}`);
                return;
            }
            
            let mainCurrency = 'Euro';
            let mainCurrencyLabel = 'Euro';
            
            if (pays.toUpperCase() === 'SUISSE') {
                mainCurrency = 'Franc Suisse';
                mainCurrencyLabel = 'Franc Suisse';
            } else if (pays.toUpperCase() === 'ANGLETERRE' || pays.toUpperCase() === 'WALES') {
                mainCurrency = 'Livre';
                mainCurrencyLabel = 'Livre Sterling';
            }
            
            const showEuroColumn = !['FRANCE', 'ALLEMAGNE', 'BELGIQUE'].includes(pays.toUpperCase());
            
            const columnMapping = {
                'Ariary': {
                    'Ventes': 3,
                    'Collecte': 4,
                    'Don': 5,
                    'Depenses': 6
                },
                'Euro': {
                    'Ventes': 7,
                    'Collecte': 8,
                    'Don': 9,
                    'Depenses': 10
                },
                'Franc Suisse': {
                    'Ventes': 11,
                    'Collecte': 12,
                    'Don': 13,
                    'Depenses': 14
                },
                'Livre': {
                    'Ventes': 15,
                    'Collecte': 16,
                    'Don': 17,
                    'Depenses': 18
                },
                'Banque Euro': {
                    'Ventes': 19,
                    'Collecte': 20,
                    'Don': 21,
                    'Depenses': 22
                }
            };
            
            let html = `
                <div class="search-stats">
                    <strong>${countryData.length} date(s) trouv√©e(s)</strong> pour : ${pays}
                </div>
                <div class="scroll-hint">Faites d√©filer horizontalement pour voir toutes les colonnes</div>
                <div class="table-scroll-container">
                    <table class="country-summary-table">
                        <thead>
                            <tr>
                                <th rowspan="2">Date</th>
                                <th colspan="4" class="currency-header">${mainCurrencyLabel}</th>
            `;
            
            if (showEuroColumn) {
                html += `<th colspan="4" class="currency-header">Euro</th>`;
            }
            
            html += `
                                <th colspan="4" class="currency-header">Banque Euro</th>
                            </tr>
                            <tr class="sub-header">
                                <th>Ventes</th>
                                <th>Collecte</th>
                                <th>Don</th>
                                <th>D√©penses</th>
            `;
            
            if (showEuroColumn) {
                html += `
                                <th>Ventes</th>
                                <th>Collecte</th>
                                <th>Don</th>
                                <th>D√©penses</th>
                `;
            }
            
            html += `
                                <th>Ventes</th>
                                <th>Collecte</th>
                                <th>Don</th>
                                <th>D√©penses</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            let totalMainVentes = 0, totalMainCollecte = 0, totalMainDon = 0, totalMainDepenses = 0;
            let totalEuroVentes = 0, totalEuroCollecte = 0, totalEuroDon = 0, totalEuroDepenses = 0;
            let totalBanqueVentes = 0, totalBanqueCollecte = 0, totalBanqueDon = 0, totalBanqueDepenses = 0;
            
            countryData.forEach(row => {
                const dateStr = row[0] || '';
                
                const mainVentes = parseFinancialValue(row[columnMapping[mainCurrency]['Ventes']] || '0');
                const mainCollecte = parseFinancialValue(row[columnMapping[mainCurrency]['Collecte']] || '0');
                const mainDon = parseFinancialValue(row[columnMapping[mainCurrency]['Don']] || '0');
                const mainDepenses = parseFinancialValue(row[columnMapping[mainCurrency]['Depenses']] || '0');
                
                const euroVentes = showEuroColumn ? parseFinancialValue(row[columnMapping['Euro']['Ventes']] || '0') : 0;
                const euroCollecte = showEuroColumn ? parseFinancialValue(row[columnMapping['Euro']['Collecte']] || '0') : 0;
                const euroDon = showEuroColumn ? parseFinancialValue(row[columnMapping['Euro']['Don']] || '0') : 0;
                const euroDepenses = showEuroColumn ? parseFinancialValue(row[columnMapping['Euro']['Depenses']] || '0') : 0;
                
                const banqueVentes = parseFinancialValue(row[columnMapping['Banque Euro']['Ventes']] || '0');
                const banqueCollecte = parseFinancialValue(row[columnMapping['Banque Euro']['Collecte']] || '0');
                const banqueDon = parseFinancialValue(row[columnMapping['Banque Euro']['Don']] || '0');
                const banqueDepenses = parseFinancialValue(row[columnMapping['Banque Euro']['Depenses']] || '0');
                
                totalMainVentes += mainVentes;
                totalMainCollecte += mainCollecte;
                totalMainDon += mainDon;
                totalMainDepenses += mainDepenses;
                
                if (showEuroColumn) {
                    totalEuroVentes += euroVentes;
                    totalEuroCollecte += euroCollecte;
                    totalEuroDon += euroDon;
                    totalEuroDepenses += euroDepenses;
                }
                
                totalBanqueVentes += banqueVentes;
                totalBanqueCollecte += banqueCollecte;
                totalBanqueDon += banqueDon;
                totalBanqueDepenses += banqueDepenses;
                
                html += `
                    <tr>
                        <td class="date-cell">${dateStr}</td>
                        <td>${formatNumberWithUnit(mainVentes, mainCurrency)}</td>
                        <td>${formatNumberWithUnit(mainCollecte, mainCurrency)}</td>
                        <td>${formatNumberWithUnit(mainDon, mainCurrency)}</td>
                        <td>${formatNumberWithUnit(mainDepenses, mainCurrency)}</td>
                `;
                
                if (showEuroColumn) {
                    html += `
                        <td>${formatNumberWithUnit(euroVentes, 'Euro')}</td>
                        <td>${formatNumberWithUnit(euroCollecte, 'Euro')}</td>
                        <td>${formatNumberWithUnit(euroDon, 'Euro')}</td>
                        <td>${formatNumberWithUnit(euroDepenses, 'Euro')}</td>
                    `;
                }
                
                html += `
                        <td>${formatNumberWithUnit(banqueVentes, 'Banque Euro')}</td>
                        <td>${formatNumberWithUnit(banqueCollecte, 'Banque Euro')}</td>
                        <td>${formatNumberWithUnit(banqueDon, 'Banque Euro')}</td>
                        <td>${formatNumberWithUnit(banqueDepenses, 'Banque Euro')}</td>
                    </tr>
                `;
            });
            
            html += `
                <tr class="total-row">
                    <td class="date-cell">TOTAL</td>
                    <td>${formatNumberWithUnit(totalMainVentes, mainCurrency)}</td>
                    <td>${formatNumberWithUnit(totalMainCollecte, mainCurrency)}</td>
                    <td>${formatNumberWithUnit(totalMainDon, mainCurrency)}</td>
                    <td>${formatNumberWithUnit(totalMainDepenses, mainCurrency)}</td>
            `;
            
            if (showEuroColumn) {
                html += `
                    <td>${formatNumberWithUnit(totalEuroVentes, 'Euro')}</td>
                    <td>${formatNumberWithUnit(totalEuroCollecte, 'Euro')}</td>
                    <td>${formatNumberWithUnit(totalEuroDon, 'Euro')}</td>
                    <td>${formatNumberWithUnit(totalEuroDepenses, 'Euro')}</td>
                `;
            }
            
            html += `
                    <td>${formatNumberWithUnit(totalBanqueVentes, 'Banque Euro')}</td>
                    <td>${formatNumberWithUnit(totalBanqueCollecte, 'Banque Euro')}</td>
                    <td>${formatNumberWithUnit(totalBanqueDon, 'Banque Euro')}</td>
                    <td>${formatNumberWithUnit(totalBanqueDepenses, 'Banque Euro')}</td>
                </tr>
            `;
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            const resultsSection = document.getElementById('resultsSection');
            const resultContent = document.getElementById('resultContent');
            const resultTitle = document.getElementById('resultTitle');
            
            resultContent.innerHTML = html;
            resultTitle.textContent = `R√©capitulatif financier pour ${pays}`;
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
